<!DOCTYPE html>
<html lang="en">
<!--
MIT License

Copyright (c) 2025 GRIFORTIS

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

==========================================================================
‚ö†Ô∏è WARNING: EXPERIMENTAL SOFTWARE ‚ö†Ô∏è
==========================================================================

This is an experimental, open-source project. Do NOT use it for important
assets at this stage.

TERMS OF USE & LIABILITY DISCLAIMER:

1. You must be offline.
   This tool is designed for air-gapped environments only. Disconnect from
   all networks before proceeding.

2. You must use a secure environment.
   For maximum security, use a temporary, trusted operating system (e.g.,
   Tails) or a fresh OS install on a secure computer.

3. You are 100% responsible.
   GRIFORTIS and its contributors are not responsible for any loss of funds,
   data corruption, or any other damages that may result from using this
   software. Use at your own risk.
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRIFORTIS ¬∑ Schiavinato Sharing (Air-Gapped)</title>
    
    <!-- FONTS: use only local system fonts, no external references -->

    <style>
        /* ==========================================================================
        GRIFORTIS - DESIGN SYSTEM (v0.2.0)
        ==========================================================================
        */

        :root {
            /* --- 1. BRAND COLORS (FIXED) --- */
            --brand-navy: #0B1019;
            --brand-titanium: #E3E4E6;
            --cyber-gold: #F4B400;
            --error-red: #FF4444;
            --success-green: #00E676; /* "Signal Green" for success */

            /* --- 2. DARK THEME (DEFAULT) --- */
            --bg-main: var(--brand-navy);
            --bg-card: #151E2E;
            --text-main: var(--brand-titanium);
            --text-muted: #8A8D91;
            --border-color: #2C3E50;
            --input-bg: rgba(0,0,0,0.3);
            --input-text: #fff;
            --shadow-color: rgba(0,0,0,0.5);
            
            --btn-disabled-bg: #2C3E50;
            --btn-disabled-text: #586376;
            --btn-cancel-border: #4A5568;
            
            --alert-error-bg: #3b1f1f;
            --alert-error-border: #7a2c2c;
            --alert-error-text: #fecaca;
            
            --alert-success-bg: #113a29;
            --alert-success-border: #1a6445;
            --alert-success-text: #bbf7d0;
            
            color-scheme: dark;
        }

        /* --- 3. LIGHT THEME (ALTERNATE) --- */
        [data-theme="light"] {
            --bg-main: #F0F2F5;
            --bg-card: #FFFFFF;
            --text-main: var(--brand-navy);
            --text-muted: #5E6C84;
            --border-color: #D1D5DB;
            --input-bg: #F7F9FC;
            --input-text: var(--brand-navy);
            --shadow-color: rgba(0,0,0,0.1);
            
            --btn-disabled-bg: #E2E8F0;
            --btn-disabled-text: #A0AEC0;
            --btn-cancel-border: #CBD5E0;
            
            --alert-error-bg: #FEEEEE;
            --alert-error-border: #FCA5A5;
            --alert-error-text: #7f1d1d;
            
            --alert-success-bg: #E6F8F2;
            --alert-success-border: #6EE7B7;
            --alert-success-text: #064e3b;
            
            color-scheme: light;
        }

        /* --- 4. BASIC RESET AND TRANSITIONS --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            /* Font stack using local system fonts only */
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            font-weight: 400;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* --- 5. TYPOGRAPHY (VOICE) --- */
        h1, h2, h3, h4 {
            /* Headings using bold system fonts */
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            font-weight: 800;
            text-transform: uppercase;
            color: var(--text-main);
            letter-spacing: 0.5px;
            margin-bottom: 0.5em;
        }
        h1 { font-size: 2.5rem; }
        h2 { font-size: 1.75rem; /*margin-top: 2em;*/ }
        h3 { font-size: 1.25rem; font-weight: 700; margin-top: 1.5em; }
        h4 { font-size: 1rem; font-weight: 700; margin-top: 1em; }
        p { font-size: 1rem; margin-bottom: 1em; }
        code, .mono { 
            /* Monospaced text using common local system fonts only */
            font-family: "SF Mono", Menlo, Consolas, "Liberation Mono", monospace; 
            background: var(--input-bg);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.9em;
        }
        a { 
            color: var(--cyber-gold); 
            text-decoration: none; 
            border-bottom: 1px dashed var(--cyber-gold);
            transition: all 0.2s;
        }
        a:hover { color: var(--text-main); border-bottom: 1px solid var(--text-main); }
        hr { border: 0; border-top: 1px solid var(--border-color); margin: 2em 0; }

        /* --- 6. LAYOUT (CONTAINERS) --- */
        .container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding: 15px 0;
            margin-bottom: 20px;
        }
        .header h1 { 
            font-size: 1.5rem; margin: 0; 
            background: -webkit-linear-gradient(45deg, var(--text-main), var(--text-muted));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .theme-toggle {
            background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main);
            padding: 8px 16px; border-radius: 50px; cursor: pointer; font-weight: 600;
            font-size: 0.9rem; display: flex; gap: 8px; align-items: center;
        }
        .component-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px var(--shadow-color);
            margin-bottom: 20px;
        }
        
        /* --- 7. FORMS (INPUT FIELDS) --- */
        .form-group { margin-bottom: 1rem; }
        label { 
            display: block; font-size: 0.9rem; 
            /* Labels use the same system font stack as the body */
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            font-weight: 600; 
            color: var(--text-muted); margin-bottom: 8px; 
        }
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="date"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--input-text);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--cyber-gold);
            box-shadow: 0 0 0 2px rgba(244, 180, 0, 0.3);
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: var(--bg-main) invert(1);
        }
        [data-theme="light"] input[type="date"]::-webkit-calendar-picker-indicator {
            filter: none;
        }
        
        /* Custom checkbox & radio controls */
        .choice-group { display: flex; align-items: center; margin-bottom: 10px; }
        .choice-group input { opacity: 0; width: 0; height: 0; }
        .choice-group label {
            display: flex; align-items: center; cursor: pointer;
            font-family: 'Inter', sans-serif; font-weight: 400;
            color: var(--text-main);
        }
        .choice-group label::before {
            content: '';
            width: 18px; height: 18px;
            border: 2px solid var(--border-color);
            background: var(--input-bg);
            margin-right: 12px;
            transition: all 0.2s;
        }
        /* Checkbox */
        input[type="checkbox"] + label::before { border-radius: 4px; }
        input[type="checkbox"]:checked + label::before {
            background-color: var(--cyber-gold);
            border-color: var(--cyber-gold);
            content: '‚úì'; /* Checkmark */
            color: #000;
            font-weight: 900;
            text-align: center;
            line-height: 15px;
        }
        /* Radio */
        input[type="radio"] + label::before { border-radius: 50%; }
        input[type="radio"]:checked + label::before {
            background-color: var(--bg-card);
            border-color: var(--cyber-gold);
            box-shadow: inset 0 0 0 4px var(--cyber-gold); /* Center dot */
        }
        
        /* --- 8. BUTTONS (ACTIONS) --- */
        .btn {
            width: auto;
            padding: 12px 24px;
            border-radius: 10px;
            border: 1px solid transparent;
            background-color: transparent;
            color: var(--text-main);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            font-weight: 800;
            font-size: 0.9rem;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 0 0 rgba(0, 0, 0, 0);
        }
        .btn:disabled {
            border: 1px solid var(--border-color);
            background-color: rgba(255, 255, 255, 0.03);
            color: var(--text-muted);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            pointer-events: none;
            filter: none;
        }
        /* Style 2 ‚Äì Secondary / Unselected */
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(244, 180, 0, 0.25);
            color: var(--text-main);
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.15);
        }
        .btn-secondary:not(:disabled):hover,
        .btn-secondary:not(:disabled):focus-visible {
            border-color: var(--cyber-gold);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
            transform: translateY(-2px);
        }
        /* Style 3 ‚Äì CTA / Selected */
        .btn-primary {
            border: 1px solid var(--cyber-gold);
            background-color: var(--cyber-gold);
            color: #000;
            box-shadow: 0 6px 20px rgba(244, 180, 0, 0.35);
        }
        .btn-primary:not(:disabled):hover,
        .btn-primary:not(:disabled):focus-visible {
            filter: brightness(1.02);
            border-color: #ffd866;
            transform: translateY(-2px);
            box-shadow: 0 10px 24px rgba(244, 180, 0, 0.45);
        }
        
        /* --- 9. MESSAGES & ALERTS --- */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid transparent;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        /* Success (green) */
        .alert-success {
            background-color: var(--alert-success-bg);
            border-color: var(--alert-success-border);
            color: var(--alert-success-text);
        }
        /* Error (red) */
        .alert-error {
            background-color: var(--alert-error-bg);
            border-color: var(--alert-error-border);
            color: var(--alert-error-text);
        }
        
        /* --- 10. DISCLAIMER / FOOTER --- */
        .disclaimer {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1.5rem;
        }

        /* Custom style for seed word inputs */
        .seed-word-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .seed-word-row label {
            font-family: "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
            color: var(--text-muted);
            width: 30px; /* fixed width for alignment */
            text-align: right;
            margin-bottom: 0; /* Override default label margin */
        }
        .seed-word-row input {
            flex-grow: 1;
        }

        /* Page 2: Share Card Refinements */
        .share-card h3 {
            margin-top: 0;
        }
        .share-metadata {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 0.5rem 2rem;
            margin: 1.5rem 0;
        }
        .share-metadata p {
            margin-bottom: 0.5em;
        }

        .share-word-container {
            background: var(--input-bg);
            padding: 20px;
            border-radius: 8px;
        }
        .share-word-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px 10px; /* Increased vertical gap */
        }
        .share-word-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .share-word-item label {
            font-family: "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
            color: var(--text-muted);
            width: 30px; /* fixed width for alignment */
            text-align: right;
            flex-shrink: 0;
        }
        .share-word-item code.mono {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: center;
            border-radius: 6px; /* Match input fields */
            flex-grow: 1;
            width: 100%;
        }

        /* Autocomplete & Validation Styles */
        #autocomplete-suggestions {
            position: absolute;
            border: 1px solid var(--border-color);
            background-color: var(--bg-card);
            box-shadow: 0 4px 20px var(--shadow-color);
            border-radius: 8px;
            z-index: 1001;
            max-height: calc(100vh - 40px); /* Limit height to viewport with some padding */
            min-width: 200px; /* Give it a minimum width */
            overflow-y: auto;
        }
        .autocomplete-suggestion {
            padding: 10px;
            cursor: pointer;
            font-family: "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
        }
        .autocomplete-suggestion.autocomplete-active {
            background-color: var(--input-bg);
            color: var(--cyber-gold);
        }
        input.invalid {
            border-color: var(--error-red) !important;
            box-shadow: 0 0 0 2px rgba(255, 68, 68, 0.3) !important;
        }

        /* Sub-header Styles */
        .flow-subheader {
            font-size: 1.25rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        /* Landing Page Specific Styles */
        #pageLanding .component-card ul {
            padding-left: 25px; /* Indent the list */
            margin-top: 1em;
        }
        #pageLanding .component-card li {
            margin-bottom: 1em; /* Add space between list items */
        }

        /* Home Page Styles */
        .home-button {
            display: block;
            width: 100%;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--bg-card);
            color: var(--text-main);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .home-button:hover {
            border-color: var(--cyber-gold);
            transform: translateY(-3px);
            box-shadow: 0 4px 20px var(--shadow-color);
        }
        .home-button h2 {
            font-size: 1.75rem;
            margin: 0 0 10px 0;
        }
        .home-button p {
            font-size: 1rem;
            color: var(--text-muted);
            margin: 0;
        }

        .home-button:disabled {
            background-color: rgba(255, 255, 255, 0.03);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .home-button:disabled:hover { border-color: var(--border-color); }

        /* Recover Page Styles */
        .horizontal-radio-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .share-input-container {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: var(--bg-card);
        }
        .share-input-container h3 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
        }
        .manual-helper-share-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 1.5rem;
        }
        .manual-helper-share-inputs .form-group {
            margin-bottom: 0;
        }
        .manual-helper-share-inputs label {
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        .manual-helper-share-inputs input {
            width: 100%;
        }
        .manual-helper-error {
            display: none;
            margin-top: 1rem;
        }
        .lagrange-output {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-top: 1.5rem;
        }
        .lagrange-result-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            background: var(--input-bg);
        }
        .lagrange-result-item p {
            margin: 0 0 0.4rem 0;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        .lagrange-result-item code {
            display: block;
            text-align: center;
            font-size: 1.1rem;
            padding: 10px;
        }
        #scheme-explanation {
            height: 100%;
            min-height: 360px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #scheme-explanation ul,
        #scheme-explanation ol {
            list-style: none;
            padding-left: 0;
            margin-left: 0;
        }
        #scheme-explanation li {
            padding-left: 0;
            margin-left: 0;
        }
        #scheme-explanation h4 {
            margin-top: 0;
        }
        #scheme-explanation > *:last-child {
            margin-bottom: 0;
        }
        @media (max-width: 768px) {
            #scheme-explanation {
                min-height: auto;
            }
        }


        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 450px;
            text-align: center;
        }
        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* --- 11. PRINT STYLES --- */
        @media print {
            /* Hide all screen elements and show only the dedicated print container */
            body > .container, .header, .disclaimer, .modal-overlay, .theme-toggle {
                display: none;
            }
            #print-output {
                display: block;
            }
            
            /* Force light theme colors for better readability and ink saving */
            body {
                --bg-main: #FFFFFF;
                --bg-card: #FFFFFF;
                --text-main: #0B1019;
                --text-muted: #5E6C84;
                --border-color: #AEB5BC;
                --input-bg: #F0F2F5;
                --input-text: var(--brand-navy);
                --shadow-color: transparent;
            }
            
            /* General print setup */
            body, .container {
                width: 100%;
                margin: 0;
                padding: 0;
            }

            /* Reset card styles for printing */
            .component-card {
                box-shadow: none;
                border: 1px solid var(--border-color);
                margin-bottom: 20px;
            }
            
            /* Page break logic for each share inside the print container */
            #print-output .share-card {
                break-before: page; /* Modern property */
                page-break-before: always; /* Older property */
            }

            /* Prevent page break on the first share card */
            #print-output .share-card:first-child {
                break-before: auto;
                page-break-before: auto;
            }

            /* Hide on-screen buttons inside the share display area if any exist */
            #shares-output .btn, #btn-back-to-create1, #btn-start-over-create {
                 display: none;
            }
        }

    </style>
</head>
<body>

    <div class="container">
        <!-- ==========================================================================
        HEADER
        - Contains the main title and theme toggle.
        - This header is persistent across all pages.
        ========================================================================== -->
        <header class="header">
            <div style="display: flex; align-items: center;">
                <h1>Schiavinato Sharing</h1>
            </div>
            <button id="theme-toggle-btn" class="theme-toggle">
                <span id="toggle-icon">‚òÄÔ∏è</span> <span id="toggle-text">Light Mode</span>
            </button>
        </header>

        <!-- ==========================================================================
        MAIN CONTENT WRAPPER
        - Contains all application "pages". Only one page is visible at a time.
        ========================================================================== -->
        <main>
            <!-- ==========================================================================
            PAGE -1: LANDING & DISCLAIMER
            - The very first page the user sees.
            - Forces the user to acknowledge the risks before proceeding.
            ========================================================================== -->
            <section id="pageLanding">
                <div class="component-card">
                    <h2 style="color: var(--error-red); text-align: center;">‚ö†Ô∏è WARNING: EXPERIMENTAL SOFTWARE ‚ö†Ô∏è</h2>
                    <p style="text-align: center; font-weight: 600;">
                        This is an experimental, open-source project. Do NOT use it for important assets at this stage.
                    </p>
                    <hr>
                    <h3>Terms of Use & Liability Disclaimer</h3>
                    <ul>
                        <li><strong>You must be offline.</strong> This tool is designed for air-gapped environments only. Disconnect from all networks before proceeding.</li>
                        <li><strong>You must use a secure environment.</strong> For maximum security, use a temporary, trusted operating system (e.g., Tails) or a fresh OS install on a secure computer.</li>
                        <li><strong>You are 100% responsible.</strong> GRIFORTIS and its contributors are not responsible for any loss of funds, data corruption, or any other damages that may result from using this software. Use at your own risk.</li>
                    </ul>
                    <hr>
                    <div class="form-group" style="margin-top: 20px;">
                        <div class="choice-group">
                            <input type="checkbox" id="disclaimer-checkbox">
                            <label for="disclaimer-checkbox">I have read the warnings, I know exactly what I'm doing, and I'm aware of the risks.</label>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button id="btn-continue-to-home" class="btn btn-primary" disabled>Continue</button>
                    </div>
                </div>
            </section>
            
            <!-- This container will hold the sub-header for the flows -->
            <h2 id="flow-subheader" class="flow-subheader" style="display: none;"></h2>

            <!-- ==========================================================================
            SHARED COMPONENT: SCHEME SELECTOR
            - This component is moved out of pageCreate1 to be reused.
            - It is dynamically appended into the correct page by the showPage() function.
            ========================================================================== -->
            <div class="component-card" id="shared-scheme-selector" style="display: none;">
                <h2>2. Splitting Scheme (Sharding)</h2>
                <div style="display: flex; gap: 30px; align-items: stretch;">
                    <!-- Scheme Radio Buttons -->
                    <div class="form-group" style="flex: 1;">
                        <label>Select scheme</label>
                        <div class="choice-group">
                            <input type="radio" id="scheme-2of3" name="scheme" value="2of3" checked>
                            <label for="scheme-2of3">2-of-3: The Smart Standard</label>
                        </div>
                        <div class="choice-group">
                            <input type="radio" id="scheme-2of4" name="scheme" value="2of4">
                            <label for="scheme-2of4">2-of-4: The Legacy Protocol</label>
                        </div>
                        <div class="choice-group">
                            <input type="radio" id="scheme-3of5" name="scheme" value="3of5">
                            <label for="scheme-3of5">3-of-5: The Sovereign Fortress</label>
                        </div>
                    </div>
                    <!-- Dynamic Scheme Explanation -->
                    <div id="scheme-explanation" style="flex: 2; background: var(--input-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                        <!-- Explanation is dynamically inserted here by JS -->
                    </div>
                </div>
            </div>

            <!-- ==========================================================================
            PAGE 0: HOME
            - The main entry point of the application.
            - Provides navigation to the two primary flows: Create and Recover.
            ========================================================================== -->
            <section id="pageHome" style="display: none;">
                <button class="home-button" id="btn-go-to-recover">
                    <h2>Recover Wallet</h2>
                    <p>Enter your share data to recover the original seed phrase</p>
                </button>
                <button class="home-button" id="btn-manual-recovery-helper">
                    <h2>Manual Recovery Helper</h2>
                    <p>Generate Lagrange multipliers to recombine paper shares offline</p>
                </button>

                <hr style="margin: 30px 0;">

                <button class="home-button" id="btn-go-to-create">
                    <h2>Create Shares</h2>
                    <p>Split your seed phrase into multiple secure shares</p>
                </button>
                <button class="home-button" id="btn-manual-sharding-helper">
                    <h2>Manual Sharding Helper</h2>
                    <p>Generate secure random numbers for pencil & paper sharding</p>
                </button>
            </section>
            
            <!-- ==========================================================================
            PAGE 1: CREATE SHARES - DATA INPUT
            - The first step in the "Create Shares" flow.
            - Collects all necessary data from the user.
            ========================================================================== -->
            <section id="pageCreate1" style="display: none;">
                
                <!-- Section 1.1: Wallet Metadata -->
                <div class="component-card">
                    <h2>1. Identification and Date</h2>
                    <div style="display: flex; gap: 20px;">
                        <!-- Wallet Identifier Input -->
                        <div class="form-group" style="flex: 2;">
                            <label for="wallet-identifier">Wallet Identifier (Optional)</label>
                            <input type="text" id="wallet-identifier" class="mono" placeholder="E.g., Main Wallet" maxlength="40">
                        </div>
                        <!-- Creation Date Input -->
                        <div class="form-group" style="flex: 1;">
                            <label for="creation-date">Creation Date</label>
                            <input type="date" id="creation-date" class="mono">
                        </div>
                    </div>
                </div>

                <!-- Section 1.2: Sharding Scheme Selection Placeholder -->
                <div id="create-scheme-placeholder"></div>

                <!-- Section 1.3: Seed Phrase Input -->
                <div class="component-card">
                    <h2>3. Seed Phrase</h2>
                    <!-- Word Count Toggle -->
                    <div class="form-group" style="text-align: center;">
                        <button id="btn-12-words" class="btn btn-secondary">12 Words</button>
                        <button id="btn-24-words" class="btn btn-primary">24 Words</button>
                    </div>
                    <!-- Container for dynamic seed word inputs -->
                    <div id="seed-word-inputs" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <!-- Inputs are dynamically inserted here by JS -->
                    </div>
                </div>

                <!-- Page 1 Footer Buttons -->
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button class="btn btn-secondary btn-back-home">Back to Home</button>
                    <button id="btn-generate-shares" class="btn btn-primary">Generate Shares</button>
                </div>
            </section>

            <!-- ==========================================================================
            PAGE 2: CREATE SHARES - DISPLAY
            - The second step in the "Create Shares" flow.
            - Displays the generated shares ready for printing or transcription.
            ========================================================================== -->
            <section id="pageCreate2" style="display: none;">

                <!-- Instructions and Print Button -->
                <div class="component-card">
                    <h2>Shares Generated</h2>
                    <p>Your shares are ready. Transcribe or print them and store them in a safe place. <strong>All data shown below must be transcribed onto each corresponding share.</strong></p>
                    <div class="alert alert-error">
                        <strong>ATTENTION:</strong> This data will not be saved. After closing this page, it will be gone forever. Double-check everything before you leave.
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button id="btn-print-shares" class="btn btn-primary" type="button" disabled title="Printing will be available soon">üñ®Ô∏è Print Shares</button>
                    </div>
                </div>

                <!-- Container for dynamically generated share cards -->
                <div id="shares-output">
                    <!-- Example of a single share card -->
                    <div class="component-card share-card">
                        <h3>Share 1 of 3</h3>
                        <hr>
                        <div class="share-metadata">
                            <p><strong>Wallet Identifier:</strong> Main Wallet</p>
                            <p><strong>Creation Date:</strong> 2025-11-21</p>
                            <p><strong>Share Number (X):</strong> 1</p>
                            <p><strong>Scheme Threshold (K):</strong> 2</p>
                            <p><strong>Original Seed Phrase Length:</strong> 24</p>
                            <p><strong>Global Checksum:</strong> <code class="mono">abandon - 0001</code></p>
                        </div>
                        <h4 style="margin-top: 25px; margin-bottom: 10px; color: var(--text-muted); font-weight: 600;">Encrypted Seed Phrase (Y) - Not a real BIP39 seed phrase</h4>
                        <div class="share-word-container">
                            <div class="share-word-list">
                                <div class="share-word-item"><label>1.</label><code class="mono">hospital - 0876</code></div>
                                <div class="share-word-item"><label>2.</label><code class="mono">spray - 1654</code></div>
                                <div class="share-word-item"><label>3.</label><code class="mono">logic - 1042</code></div>
                                <div class="share-word-item"><label>C1.</label><code class="mono">lemon - 1014</code></div>
                                <div class="share-word-item"><label>4.</label><code class="mono">manual - 1083</code></div>
                                <div class="share-word-item"><label>5.</label><code class="mono">forward - 0721</code></div>
                                <div class="share-word-item"><label>6.</label><code class="mono">vehicle - 1959</code></div>
                                <div class="share-word-item"><label>C2.</label><code class="mono">glass - 0789</code></div>
                            </div>
                        </div>
                    </div>
                    <!-- End of example -->
                </div>

                <!-- Page 2 Footer Buttons -->
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button id="btn-back-to-create1" class="btn btn-secondary">‚Üê Go Back and Edit</button>
                    <button id="btn-start-over-create" class="btn btn-primary">Clear All & Start Over</button>
                </div>
            </section>

            <!-- ==========================================================================
            PAGE 2.5A: MANUAL RECOVERY HELPER
            ========================================================================== -->
            <section id="pageManualRecovery" style="display: none;">
                
                <div class="component-card">
                    <h2>How Lagrange Multipliers Restore Your Wallet</h2>
                    <p>This helper gives you the exact multipliers (Œª) needed to recombine your paper shares. Multiply each encrypted value (Y) by its multiplier, sum the results, and reduce modulo 2053 to recover a row.</p>
                    <ol style="padding-left: 20px; margin-top: 1rem;">
                        <li style="margin-bottom: 0.75em;">Record the share numbers (the <span class="mono">X</span> printed on each share) for the <strong>K</strong> shares you possess.</li>
                        <li style="margin-bottom: 0.75em;">Use the multipliers to compute <code>Recovered = Œ£(Y √ó Œª) mod 2053</code> for each word and checksum row.</li>
                        <li style="margin-bottom: 0.75em;">Repeat for every row and finally verify the global checksum to confirm the recovery.</li>
                    </ol>
                    <p style="margin-top: 1rem; font-size: 0.95rem; color: var(--text-muted);">After every row, add the three recovered word numbers together and confirm they match the recovered checksum for that row. When you finish all rows, sum every recovered word and verify that it equals the recovered global checksum verification value before rebuilding the mnemonic.</p>
                </div>

                <div class="component-card">
                    <h2>1. Select Scheme & Share Numbers</h2>
                    <p>Switch between schemes and enter the share numbers (<span class="mono">X</span>) for the shares you currently have. Each share number must be unique.</p>
                    <div id="manual-recovery-scheme-placeholder"></div>
                    <div class="manual-helper-share-inputs" id="manual-recovery-share-inputs"></div>
                    <div id="manual-recovery-error" class="alert alert-error manual-helper-error"></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button id="btn-show-multipliers" class="btn btn-primary" type="button" disabled>Show Multipliers</button>
                    </div>
                </div>

                <div class="component-card" id="manual-helper-results-card">
                    <h2>2. Lagrange Multipliers</h2>
                    <p>Use these multipliers with the corresponding share numbers. They only change if you change the set of shares being combined.</p>
                    <div id="manual-recovery-output" class="lagrange-output">
                        <p style="grid-column: 1 / -1; text-align: center; color: var(--text-muted); margin: 0;">Enter the share numbers above to see the multipliers.</p>
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-start; margin-top: 20px;">
                    <button class="btn btn-secondary btn-back-home">Back to Home</button>
                </div>
            </section>

            <!-- ==========================================================================
            PAGE 2.5B: MANUAL SHARDING HELPER
            ========================================================================== -->
            <section id="pageManualSharding" style="display: none;">
                
                <div class="component-card">
                    <h2>How to Use This Tool</h2>
                    <p>This tool helps you perform Schiavinato Sharing manually with pencil and paper by providing the necessary secure random numbers.</p>
                    <ol style="padding-left: 20px; margin-top: 1rem;">
                        <li style="margin-bottom: 1em;">
                            <strong>Get your BIP39 word indices:</strong> Find your 12 or 24 secret words on the official BIP39 English wordlist. You need the number (index) for each word. Our tool uses a <strong>zero-indexed</strong> list (the first word, "abandon", is 0). Be careful, as some lists online (like the one on GitHub) show line numbers starting from 1, which will produce incorrect results if used directly. Pro tip: paste the wordlist into a spreadsheet and number it starting from 0.
                        </li>
                        <li style="margin-bottom: 1em;">
                            <strong>Calculate Point Coordinates:</strong> For each of your secret word indices, use the polynomial equation shown above to calculate a "share" value (Y). The 'X' in the equation is the share number (e.g., 1 for the first share, 2 for the second, and so on).
                        </li>
                        <li style="margin-bottom: 1em;">
                            <strong>All calculations are modulo 2053.</strong> This is a prime number. To perform a "modulo" operation, you divide your result by 2053 and take the remainder. For example, <code>2055 mod 2053</code> is <code>2</code>.
                        </li>
                    </ol>
                </div>

                <div id="manual-sharding-scheme-placeholder"></div>

                <div class="component-card">
                    <h2>2. Polynomial Equation</h2>
                    <p>This is the equation used to generate your shares. Replace <code>&lt;BIP39 word indices&gt;</code> with your secret numbers (from 0 to 2047).</p>
                    <div id="polynomial-display" style="background: var(--input-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); text-align: center; margin-top: 1rem;">
                        <p style="margin: 0; color: var(--text-muted);">Select a scheme to generate a fresh equation.</p>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button class="btn btn-secondary btn-back-home">Back to Home</button>
                    <button id="btn-random-again" class="btn btn-primary">Random Again</button>
                </div>
            </section>

            <!-- ==========================================================================
            PAGE 3: RECOVER WALLET - DATA INPUT
            - The first step in the "Recover Wallet" flow.
            - Dynamically generates input fields based on user's scheme selection.
            ========================================================================== -->
            <section id="pageRecover1" style="display: none;">
                <!-- Section 3.1: Recovery Parameters -->
                <div class="component-card">
                    <h2>1. Enter Recovery Parameters</h2>
                    <div style="display: flex; gap: 30px; align-items: flex-end;">
                        <!-- Scheme Threshold Selection -->
                        <div class="form-group" style="flex: 1;">
                            <label>Scheme Threshold (K)</label>
                            <div class="horizontal-radio-group">
                                <div class="choice-group">
                                    <input type="radio" id="recover-k-2" name="recover-k" value="2" checked>
                                    <label for="recover-k-2">2</label>
                                </div>
                                <div class="choice-group">
                                    <input type="radio" id="recover-k-3" name="recover-k" value="3">
                                    <label for="recover-k-3">3</label>
                                </div>
                            </div>
                        </div>
                        <!-- Word Count Toggle -->
                        <div class="form-group" style="flex: 2;">
                            <label>Original Seed Phrase Length</label>
                            <div>
                                <button id="recover-btn-12-words" class="btn btn-secondary">12 Words</button>
                                <button id="recover-btn-24-words" class="btn btn-primary">24 Words</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 3.2: Dynamic Share Inputs -->
                <div id="recover-shares-container">
                    <!-- Share input blocks are dynamically inserted here by JS -->
                </div>

                <!-- Page 3 Footer Buttons -->
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button class="btn btn-secondary btn-back-home">Back to Home</button>
                    <button id="btn-recover-wallet" class="btn btn-primary">Recover Wallet</button>
                </div>
            </section>

            <!-- ==========================================================================
            PAGE 4: RECOVER WALLET - DISPLAY
            - The second step in the "Recover Wallet" flow.
            - Displays the successfully recovered original seed phrase.
            ========================================================================== -->
            <section id="pageRecover2" style="display: none;">
                <!-- Success Message and Print Button -->
                <div class="component-card">
                    <h2>Wallet Recovered</h2>
                    <div class="alert alert-success">
                        <strong>SUCCESS:</strong> The original seed phrase has been recovered.
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button id="btn-print-recovered" class="btn btn-primary" type="button" disabled title="Printing will be available soon">üñ®Ô∏è Print Recovered Seed</button>
                    </div>
                </div>

                <!-- Recovered Seed Phrase Display -->
                <div class="component-card">
                    <h4 style="margin-top: 0; margin-bottom: 15px; color: var(--text-muted); font-weight: 600;">Original BIP39 Seed Phrase</h4>
                    <div class="share-word-list" style="grid-template-columns: repeat(3, 1fr);">
                        <!-- Example for 24 words -->
                        <div class="share-word-item"><label>1.</label><code class="mono">abandon</code></div>
                        <div class="share-word-item"><label>2.</label><code class="mono">ability</code></div>
                        <div class="share-word-item"><label>3.</label><code class="mono">able</code></div>
                        <div class="share-word-item"><label>4.</label><code class="mono">about</code></div>
                        <div class="share-word-item"><label>5.</label><code class="mono">above</code></div>
                        <div class="share-word-item"><label>6.</label><code class="mono">absent</code></div>
                        <div class="share-word-item"><label>7.</label><code class="mono">absorb</code></div>
                        <div class="share-word-item"><label>8.</label><code class="mono">abstract</code></div>
                        <div class="share-word-item"><label>9.</label><code class="mono">absurd</code></div>
                        <div class="share-word-item"><label>10.</label><code class="mono">abuse</code></div>
                        <div class="share-word-item"><label>11.</label><code class="mono">access</code></div>
                        <div class="share-word-item"><label>12.</label><code class="mono">accident</code></div>
                        <div class="share-word-item"><label>13.</label><code class="mono">account</code></div>
                        <div class="share-word-item"><label>14.</label><code class="mono">accuse</code></div>
                        <div class="share-word-item"><label>15.</label><code class="mono">achieve</code></div>
                        <div class="share-word-item"><label>16.</label><code class="mono">acid</code></div>
                        <div class="share-word-item"><label>17.</label><code class="mono">acoustic</code></div>
                        <div class="share-word-item"><label>18.</label><code class="mono">acquire</code></div>
                        <div class="share-word-item"><label>19.</label><code class="mono">across</code></div>
                        <div class="share-word-item"><label>20.</label><code class="mono">act</code></div>
                        <div class="share-word-item"><label>21.</label><code class="mono">action</code></div>
                        <div class="share-word-item"><label>22.</label><code class="mono">actor</code></div>
                        <div class="share-word-item"><label>23.</label><code class="mono">actress</code></div>
                        <div class="share-word-item"><label>24.</label><code class="mono">actual</code></div>
                    </div>
                </div>

                 <!-- Page 4 Footer Buttons -->
                 <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button id="btn-back-to-recover1" class="btn btn-secondary">‚Üê Go Back and Edit</button>
                    <button id="btn-start-over-recover" class="btn btn-primary">Clear All & Start Over</button>
                </div>
            </section>

            <!-- ==========================================================================
            DISCLAIMER / FOOTER
            - Persistent footer for all pages.
            ========================================================================== -->
            <footer class="disclaimer">
                <p style="text-align: center; font-weight: 600; margin: 0;">
                    ¬© 2025 GRIFORTIS. Released under the MIT License. v0.2.0
                </p>
            </footer>
        </main>
    </div>

    <!-- ==========================================================================
    PRINT-ONLY OUTPUT
    - A dedicated container for generating a clean, printable version of shares.
    - Populated by JavaScript and only made visible via print media queries.
    ========================================================================== -->
    <div id="print-output" style="display: none;"></div>

    <!-- ==========================================================================
    MODAL DIALOG
    - A custom confirmation dialog to replace native browser prompts.
    - Controlled by the `showConfirmationModal` function in JavaScript.
    ========================================================================== -->
    <div id="custom-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="modal-title">Are you sure?</h3>
            <p id="modal-text">This action cannot be undone.</p>
            <div class="modal-buttons">
                <button id="modal-cancel" class="btn btn-secondary">Cancel</button>
                <button id="modal-confirm" class="btn btn-primary">Confirm</button>
            </div>
        </div>
    </div>

    <!-- ==========================================================================
    AUTOCOMPLETE SUGGESTIONS CONTAINER
    - A single, reusable floating container for autocomplete suggestions.
    - It is positioned and populated by JavaScript.
    ========================================================================== -->
    <div id="autocomplete-suggestions" style="display: none;"></div>

    <!-- ==========================================================================
    UI BEHAVIOR SCRIPT
    - This script handles all UI interactions, dynamic content, and navigation.
    - It contains NO core cryptographic logic.
    ========================================================================== -->
    <script>
        // ==========================================================================
        //
        //                                  UI LOGIC
        //
        // ==========================================================================

        // ==========================================================================
        // SECTION 1: UI - APPLICATION STATE & CACHE
        // ==========================================================================
        
        /** Custom error for checksum failures to pass row info to UI */
        class ChecksumError extends Error {
            constructor(message, row) {
                super(message);
                this.name = 'ChecksumError';
                this.row = row; // row is 0-indexed
            }
        }
        
        // Note: These constants are also defined in SchiavinatoSharing module below.
        // Both definitions are needed because they exist in different closure contexts
        // (UI script scope vs. library module scope) for proper encapsulation.
        const WORDS_PER_ROW = 3;
        const FIELD_PRIME = 2053;
        
        let createFlowWordCache = Array(24).fill('');
        let createWordCount = 24;

        let recoverFlowCache = [];
        const MAX_SHARES = 5;
        for (let i = 0; i < MAX_SHARES; i++) {
            recoverFlowCache.push({ shareNumber: '', words: Array(32).fill('') });
        }
        let recoverWordCount = 24;
        const manualRecoveryShareCache = {};

        let activeSuggestionIndex = -1;
        let allowMouseHover = false;
        let currentAutocompleteInput = null;

        /**
         * Builds a deterministic field id for recovery inputs.
         */
        function buildRecoveryFieldId(shareIndex, rowIndex, slot) {
            return `recover-share-${shareIndex}-row-${rowIndex}-${slot}`;
        }

        /**
         * Returns a human-readable label for a recovery input.
         */
        function buildRecoveryFieldLabel(shareIndex, rowIndex, slot) {
            const rowNumber = rowIndex + 1;
            if (slot === 'checksum') {
                return `Share ${shareIndex} ¬∑ Row ${rowNumber} checksum`;
            }
            const slotParts = slot.split('-');
            const wordNumber = parseInt(slotParts[1], 10) + 1;
            return `Share ${shareIndex} ¬∑ Row ${rowNumber} word ${wordNumber}`;
        }

        /**
         * Applies a consistent invalid state to an input.
         */
        function markInputInvalid(input, message, { rowHighlight = false } = {}) {
            if (!input) return;
            input.classList.add('invalid');
            if (rowHighlight) {
                input.setAttribute('data-row-highlight', 'true');
            }
            if (message) {
                input.dataset.errorMessage = message;
                input.title = message;
            }
        }

        /**
         * Clears any invalid/row highlight state from an input.
         */
        function clearInputErrorState(input) {
            if (!input) return;
            input.classList.remove('invalid');
            input.removeAttribute('data-error-message');
            input.removeAttribute('title');
            input.removeAttribute('data-row-highlight');
        }

        /**
         * Parses a recovery field entry into a GF(2053) value.
         * Accepts: BIP39 word, raw number, or "word +/- number" combos (digits at the end).
         */
        function parseShareValue(raw, { allowNumeric = true } = {}) {
            if (raw === undefined || raw === null) {
                return { ok: false, reason: 'empty' };
            }
            const trimmed = String(raw).trim();
            if (trimmed === '') {
                return { ok: false, reason: 'empty' };
            }
            const numericMatch = trimmed.match(/(\d+)\s*$/);
            if (numericMatch) {
                if (!allowNumeric) {
                    return { ok: false, reason: 'numeric-not-allowed' };
                }
                const numeric = parseInt(numericMatch[1], 10);
                if (Number.isNaN(numeric)) {
                    return { ok: false, reason: 'nan' };
                }
                if (numeric >= 0 && numeric < FIELD_PRIME) {
                    return { ok: true, value: numeric, source: 'number' };
                }
                return { ok: false, reason: 'range', value: numeric };
            }
            const normalizedWord = trimmed.toLowerCase();
            const wordIndex = BIP39_WORDLIST.indexOf(normalizedWord);
            if (wordIndex !== -1) {
                return { ok: true, value: wordIndex, source: 'word' };
            }
            return { ok: false, reason: 'unknown' };
        }

        /**
         * Converts a parse failure into a short, human-friendly message.
         */
        function formatParseError(fieldLabel, parseResult) {
            const label = fieldLabel || 'This field';
            if (!parseResult || parseResult.ok) {
                return `${label} contains an invalid value.`;
            }
            switch (parseResult.reason) {
                case 'empty':
                    return `${label} is required.`;
                case 'range':
                    return `${label} must be between 0 and ${FIELD_PRIME - 1}.`;
                case 'numeric-not-allowed':
                    return `${label} must be a BIP39 word.`;
                case 'unknown':
                    return `${label} must be a BIP39 word or a number (formats like "olive - 1234" are accepted).`;
                default:
                    return `${label} contains an invalid value.`;
            }
        }

        /**
         * Initializes per-input tracking so we know when a user changes a field between attempts.
         */
        function initializeRecoveryInputTracking(input) {
            if (!input) return;
            input.dataset.lastAttemptValue = String(input.value ?? '');
        }

        /**
         * Persists the current values as the baseline for the next attempt.
         */
        function snapshotShareInputs() {
            const inputs = recoverSharesContainer.querySelectorAll('.share-input-container input');
            inputs.forEach(input => {
                input.dataset.lastAttemptValue = String(input.value ?? '');
            });
        }

        // ==========================================================================
        // SECTION 2: UI - DOM ELEMENT REFERENCES
        // ==========================================================================
        
        const pages = {
            landing: document.getElementById('pageLanding'),
            home: document.getElementById('pageHome'),
            create1: document.getElementById('pageCreate1'),
            create2: document.getElementById('pageCreate2'),
            manualRecovery: document.getElementById('pageManualRecovery'),
            manualSharding: document.getElementById('pageManualSharding'),
            recover1: document.getElementById('pageRecover1'),
            recover2: document.getElementById('pageRecover2'),
        };

        const disclaimerCheckbox = document.getElementById('disclaimer-checkbox');
        const btnContinueToHome = document.getElementById('btn-continue-to-home');
        const flowSubheader = document.getElementById('flow-subheader');

        const btnGoToCreate = document.getElementById('btn-go-to-create');
        const btnGoToRecover = document.getElementById('btn-go-to-recover');
        const btnManualRecoveryHelper = document.getElementById('btn-manual-recovery-helper');
        const btnManualShardingHelper = document.getElementById('btn-manual-sharding-helper');
        const btnsBackHome = document.querySelectorAll('.btn-back-home');
        const btnGenerateShares = document.getElementById('btn-generate-shares');
        const btnBackToCreate1 = document.getElementById('btn-back-to-create1');
        const btnStartOverCreate = document.getElementById('btn-start-over-create');
        const btnRecoverWallet = document.getElementById('btn-recover-wallet');
        const btnStartOverRecover = document.getElementById('btn-start-over-recover');
        const btnBackToRecover1 = document.getElementById('btn-back-to-recover1');
        const btnShowMultipliers = document.getElementById('btn-show-multipliers');

        const schemeRadios = document.querySelectorAll('input[name="scheme"]');
        const schemeExplanation = document.getElementById('scheme-explanation');
        const btn12Words = document.getElementById('btn-12-words');
        const btn24Words = document.getElementById('btn-24-words');
        const seedWordInputsContainer = document.getElementById('seed-word-inputs');

        const recoverKRadios = document.querySelectorAll('input[name="recover-k"]');
        const recoverSharesContainer = document.getElementById('recover-shares-container');
        const recoverBtn12Words = document.getElementById('recover-btn-12-words');
        const recoverBtn24Words = document.getElementById('recover-btn-24-words');
        
        const sharedSchemeSelector = document.getElementById('shared-scheme-selector');
        const createSchemePlaceholder = document.getElementById('create-scheme-placeholder');
        const manualRecoverySchemePlaceholder = document.getElementById('manual-recovery-scheme-placeholder');
        const manualShardingSchemePlaceholder = document.getElementById('manual-sharding-scheme-placeholder');
        const manualRecoveryShareInputsContainer = document.getElementById('manual-recovery-share-inputs');
        const manualRecoveryErrorBox = document.getElementById('manual-recovery-error');
        const manualRecoveryOutputContainer = document.getElementById('manual-recovery-output');
        const polynomialDisplay = document.getElementById('polynomial-display');
        const btnRandomAgain = document.getElementById('btn-random-again');

        const modal = document.getElementById('custom-modal');
        const modalConfirmBtn = document.getElementById('modal-confirm');
        const modalCancelBtn = document.getElementById('modal-cancel');
        const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
        
        const autocompleteContainer = document.getElementById('autocomplete-suggestions');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const btnPrintShares = document.getElementById('btn-print-shares');
        const btnPrintRecovered = document.getElementById('btn-print-recovered');

        // ==========================================================================
        // SECTION 3: UI - PAGE NAVIGATION
        // ==========================================================================
        
        /**
         * Hides all pages and shows the one specified by the key.
         * Also manages the visibility and content of the flow sub-header.
         * @param {string} pageKey - The key corresponding to the page in the `pages` object.
         * @param {string} [subheaderText=''] - Optional text for the flow sub-header.
         */
        function showPage(pageKey, subheaderText = '') {
            Object.values(pages).forEach(page => page.style.display = 'none');

            // Hide the shared component by default. It will be shown if its new parent page is activated.
            if (sharedSchemeSelector) {
                sharedSchemeSelector.style.display = 'none';
            }

            // Attach the shared component to the correct placeholder if the new page needs it
            if (sharedSchemeSelector) {
                if (pageKey === 'create1' && createSchemePlaceholder) {
                    createSchemePlaceholder.appendChild(sharedSchemeSelector);
                    sharedSchemeSelector.style.display = 'block';
                    sharedSchemeSelector.querySelector('h2').textContent = '2. Splitting Scheme (Sharding)';
                } else if (pageKey === 'manualRecovery' && manualRecoverySchemePlaceholder) {
                    manualRecoverySchemePlaceholder.appendChild(sharedSchemeSelector);
                    sharedSchemeSelector.style.display = 'block';
                    sharedSchemeSelector.querySelector('h2').textContent = 'Select a Splitting Scheme';
                    updateManualRecoveryShareInputs();
                } else if (pageKey === 'manualSharding' && manualShardingSchemePlaceholder) {
                    manualShardingSchemePlaceholder.appendChild(sharedSchemeSelector);
                    sharedSchemeSelector.style.display = 'block';
                    sharedSchemeSelector.querySelector('h2').textContent = 'Select a Splitting Scheme';
                    updateManualShardingEquation();
                }
            }
            
            pages[pageKey].style.display = 'block';

            if (subheaderText) {
                flowSubheader.textContent = subheaderText;
                flowSubheader.style.display = 'block';
            } else {
                flowSubheader.style.display = 'none';
            }

            window.scrollTo(0, 0); // Scroll to top on page change
        }

        btnContinueToHome.addEventListener('click', () => showPage('home'));
        btnGoToCreate.addEventListener('click', () => showPage('create1', 'Create Shares'));
        btnGoToRecover.addEventListener('click', () => showPage('recover1', 'Recover Wallet'));
        if (btnManualRecoveryHelper) {
            btnManualRecoveryHelper.addEventListener('click', () => showPage('manualRecovery', 'Manual Recovery Helper'));
        }
        if (btnManualShardingHelper) {
            btnManualShardingHelper.addEventListener('click', () => showPage('manualSharding', 'Manual Sharding Helper'));
        }
        btnsBackHome.forEach(btn => btn.addEventListener('click', () => showPage('home')));
        
        btnGenerateShares.addEventListener('click', async () => {
            try {
                // 1. Gather all inputs from the form
                const identifier = document.getElementById('wallet-identifier').value || 'Default Wallet';
                const date = document.getElementById('creation-date').value;
                const scheme = document.querySelector('input[name="scheme"]:checked').value;
                const [k, n] = scheme.split('of').map(Number);

                const words = [];
                for (let i = 1; i <= createWordCount; i++) {
                    const input = document.getElementById(`word-${i}`);
                    if (!input || !input.value) {
                        throw new Error(`Word #${i} is missing.`);
                    }
                    words.push(input.value.trim().toLowerCase());
                }
                const mnemonic = words.join(' ');

                // 2. Call the core logic function
                // Note: BIP39_WORDLIST must be globally available for this to work.
                const { shares } = await SchiavinatoSharing.splitBip39(mnemonic, k, n, BIP39_WORDLIST);
                
                // 3. Populate the next page and display it
                displayShares(shares, { identifier, date, scheme, wordCount: createWordCount });

                showPage('create2', 'Create Shares');

            } catch (error) {
                await showErrorModal('Generation Failed', error.message);
            }
        });
        
        btnBackToCreate1.addEventListener('click', async () => {
            const confirmed = await showConfirmationModal(
                'Regenerate Shares?',
                'Returning to step 1 will discard these shares and create a completely new set. If you already started copying, the new shares will not match. Do you still want to go back?'
            );
            if (confirmed) {
                showPage('create1', 'Create Shares');
            }
        });
        btnBackToRecover1.addEventListener('click', () => showPage('recover1', 'Recover Wallet'));

        btnRecoverWallet.addEventListener('click', async () => {
            const k = parseInt(document.querySelector('input[name="recover-k"]:checked').value, 10);
            const shares = [];
            const shareContainers = document.querySelectorAll('#recover-shares-container .share-input-container');

            if (shareContainers.length !== k) {
                await showErrorModal('Input Error', "The number of input forms does not match the selected threshold (K).");
                return;
            }
            
            const uiErrors = new Set();
            const seenShareNumbers = new Map(); // shareNumber -> shareIndex
            let parsingError = false;

            for (let i = 0; i < k; i++) {
                const container = shareContainers[i];
                const shareIndex = i + 1;
                container.dataset.shareIndex = String(shareIndex);

                const shareNumberInput = container.querySelector(`#recover-x-${shareIndex}`);
                const globalChecksumShareInput = container.querySelector(`#recover-global-checksum-${shareIndex}`);

                if (!shareNumberInput || !globalChecksumShareInput) {
                    uiErrors.add('A share input block is missing required fields.');
                    parsingError = true;
                    continue;
                }

                shareNumberInput.dataset.fieldLabel = `Share ${shareIndex} number`;
                shareNumberInput.dataset.allowNumeric = 'true';
                globalChecksumShareInput.dataset.fieldLabel = `Share ${shareIndex} global checksum verification`;
                globalChecksumShareInput.dataset.allowNumeric = 'true';

                const shareNumberRaw = shareNumberInput.value.trim();
                const shareNumber = Number(shareNumberRaw);
                if (!Number.isInteger(shareNumber) || shareNumber <= 0 || shareNumber >= FIELD_PRIME) {
                    const message = `Share numbers must be integers between 1 and ${FIELD_PRIME - 1}.`;
                    markInputInvalid(shareNumberInput, message);
                    uiErrors.add(message);
                    parsingError = true;
                    continue;
                }
                if (seenShareNumbers.has(shareNumber)) {
                    const existingIndex = seenShareNumbers.get(shareNumber);
                    const existingInput = document.querySelector(`#recover-x-${existingIndex}`);
                    const duplicateMessage = `Share number ${shareNumber} is duplicated. Each share must have a unique X value.`;
                    markInputInvalid(shareNumberInput, duplicateMessage);
                    if (existingInput) {
                        markInputInvalid(existingInput, duplicateMessage);
                    }
                    uiErrors.add('Duplicate share numbers detected. Resolve before continuing.');
                    parsingError = true;
                    continue;
                }
                seenShareNumbers.set(shareNumber, shareIndex);

                const globalChecksumParse = parseShareValue(globalChecksumShareInput.value, { allowNumeric: true });
                if (!globalChecksumParse.ok) {
                    markInputInvalid(globalChecksumShareInput, formatParseError(globalChecksumShareInput.dataset.fieldLabel, globalChecksumParse));
                    uiErrors.add('Fix the highlighted global checksum verification fields.');
                    parsingError = true;
                    continue;
                }

                const wordsPerChecksum = WORDS_PER_ROW;
                const numRows = recoverWordCount / wordsPerChecksum;
                const share = {
                    shareNumber,
                    shareIndex,
                    wordShares: [],
                    checksumShares: [],
                    globalChecksumVerificationShare: globalChecksumParse.value
                };

                let rowHadError = false;
                for (let rowIndex = 0; rowIndex < numRows; rowIndex++) {
                    for (let wordSlot = 0; wordSlot < wordsPerChecksum; wordSlot++) {
                        const input = container.querySelector(`input[data-row-index="${rowIndex}"][data-slot="word-${wordSlot}"]`);
                        if (!input) continue;
                        const parseResult = parseShareValue(input.value, { allowNumeric: true });
                        if (!parseResult.ok) {
                            const message = formatParseError(input.dataset.fieldLabel, parseResult);
                            markInputInvalid(input, message, { rowHighlight: true });
                            uiErrors.add('Fix the highlighted share rows before continuing.');
                            rowHadError = true;
                        } else {
                            clearInputErrorState(input);
                            share.wordShares.push(parseResult.value);
                        }
                    }
                    const checksumInput = container.querySelector(`input[data-row-index="${rowIndex}"][data-slot="checksum"]`);
                    if (checksumInput) {
                        const checksumParse = parseShareValue(checksumInput.value, { allowNumeric: true });
                        if (!checksumParse.ok) {
                            const message = formatParseError(checksumInput.dataset.fieldLabel, checksumParse);
                            markInputInvalid(checksumInput, message, { rowHighlight: true });
                            uiErrors.add('Fix the highlighted share rows before continuing.');
                            rowHadError = true;
                        } else {
                            clearInputErrorState(checksumInput);
                            share.checksumShares.push(checksumParse.value);
                        }
                    }
                }

                if (rowHadError) {
                    parsingError = true;
                    continue;
                }

                shares.push(share);
            }

            if (uiErrors.size > 0) {
                await showErrorModal('Input Error', Array.from(uiErrors).join('\n'));
                return;
            }

            if (parsingError || shares.length !== k) {
                await showErrorModal('Input Error', 'Please fix the highlighted fields before attempting recovery again.');
                return;
            }

            // 2. CALL UNIFIED RECOVERY & VALIDATION
            try {
                const report = await SchiavinatoSharing.recoverAndValidate(shares, recoverWordCount, BIP39_WORDLIST);
                
                // 3. DISPLAY RESULTS
                await displayValidationResults(report, shares);

            } catch (error) {
                // Catches errors from the UI gathering phase (e.g., parsing)
                await showErrorModal('Input Error', error.message);
            }
        });

        if (btnShowMultipliers) {
            btnShowMultipliers.addEventListener('click', () => {
                const { ok, values } = validateManualRecoveryInputs();
                if (!ok) {
                    showManualRecoveryError('Enter valid, unique share numbers to generate multipliers.');
                    resetManualRecoveryResults();
                    return;
                }
                try {
                    const multipliers = SchiavinatoSharing.computeLagrangeMultipliers(values);
                    clearManualRecoveryError();
                    displayManualRecoveryResults(values, multipliers);
                } catch (error) {
                    showManualRecoveryError(error.message || 'Could not compute multipliers. Check your inputs and try again.');
                    resetManualRecoveryResults();
                }
            });
        }

        if (btnRandomAgain) {
            btnRandomAgain.addEventListener('click', updateManualShardingEquation);
        }

        /**
         * Processes the report from the recovery function and updates the UI accordingly.
         * Implements intelligent error cascading and surgical error messages.
         * @param {Object} report - The report object from `recoverAndValidate`.
         * @param {Array<Object>} shares - The array of share objects from the UI, needed for context.
         */
        async function displayValidationResults(report, shares) {
            const { recoveredMnemonic, errors } = report;
            
            // Clear any previous error highlights
            clearAllErrorHighlights();

            // CASE 1: Generic/structural errors (highest priority)
            if (errors.generic) {
                await showErrorModal('Recovery Failed', errors.generic);
                return;
            }

            // CASE 2: Row errors exist
            if (errors.failedRows && errors.failedRows.length > 0) {
                errors.failedRows.forEach(rowError => {
                    // Highlight ALL shares - we cannot identify which specific share has the error
                    const rowIndex = rowError.rowNumber - 1;  // Convert to 0-based index
                    highlightErrorRow(rowIndex);
                });
                
                await showErrorModal('Recovery Failed', 'Recovery failed. Check the highlighted fields and try again.');
                return;
            }

            // CASE 3: Global Checksum error but all rows passed (nightmare scenario)
            if (errors.globalChecksumError && errors.globalChecksumError.failed) {
                if (errors.globalChecksumError.isNightmare) {
                    // Highlight all global checksum verification fields
                    highlightGlobalChecksumError();
                    
                    let errorMessage = 'Global Checksum verification failed.\n\n';
                    errorMessage += 'Step 1: Check the highlighted global checksum fields.\n';
                    errorMessage += 'Step 2: If global checksum fields are correct, carefully check all other fields.';
                    
                    await showErrorModal('Recovery Failed', errorMessage);
                } else {
                    await showErrorModal('Recovery Failed', 'Global Checksum failed unexpectedly.');
                }
                return;
            }

            // CASE 4: BIP39 failed but Schiavinato checks passed (show seed anyway)
            if (errors.bip39) {
                let errorMessage = 'BIP39 checksum invalid.\n\n';
                errorMessage += 'The recovered words may have errors in the final word, or the shares were created from a manually-calculated seed.\n\n';
                errorMessage += `Recovered seed:\n${recoveredMnemonic}`;
                
                const confirmed = await showConfirmationModal(
                    'BIP39 Checksum Invalid',
                    errorMessage
                );
                if (confirmed && recoveredMnemonic) {
                    snapshotShareInputs();
                    displayRecoveredMnemonic(recoveredMnemonic, true);
                    showPage('recover2', 'Recover Wallet');
                }
                return;
            }

            // CASE 5: SUCCESS - All checks passed
            if (recoveredMnemonic) {
                snapshotShareInputs();
                displayRecoveredMnemonic(recoveredMnemonic, false);
                showPage('recover2', 'Recover Wallet');
                return;
            }

            // CASE 6: Unexpected error
            await showErrorModal('Unknown Error', 'An unexpected error occurred during recovery.');
        }

        /**
         * Attempts automatic validation when all fields are filled.
         * Runs silently - only highlights errors, no modal popups.
         */
        async function attemptAutoValidation() {
            try {
                const k = parseInt(document.querySelector('input[name="recover-k"]:checked')?.value, 10);
                if (!k) return;

                const shareContainers = document.querySelectorAll('#recover-shares-container .share-input-container');
                if (shareContainers.length !== k) return;

                // Check if all fields are filled
                let allFilled = true;
                shareContainers.forEach(container => {
                    const inputs = container.querySelectorAll('input');
                    inputs.forEach(input => {
                        if (!input.value || !input.value.trim()) {
                            allFilled = false;
                        }
                    });
                });

                if (!allFilled) return;

                // Parse shares (reuse parsing logic from main recovery)
                const shares = [];
                const seenShareNumbers = new Map();
                let hasParseError = false;

                for (let i = 0; i < k; i++) {
                    const container = shareContainers[i];
                    const shareIndex = i + 1;

                    const shareNumberInput = container.querySelector(`#recover-x-${shareIndex}`);
                    const globalChecksumShareInput = container.querySelector(`#recover-global-checksum-${shareIndex}`);

                    if (!shareNumberInput || !globalChecksumShareInput) {
                        hasParseError = true;
                        continue;
                    }

                    const shareNumber = Number(shareNumberInput.value.trim());
                    if (!Number.isInteger(shareNumber) || shareNumber <= 0 || shareNumber >= FIELD_PRIME) {
                        hasParseError = true;
                        continue;
                    }

                    if (seenShareNumbers.has(shareNumber)) {
                        hasParseError = true;
                        continue;
                    }
                    seenShareNumbers.set(shareNumber, shareIndex);

                    const globalChecksumParse = parseShareValue(globalChecksumShareInput.value, { allowNumeric: true });
                    if (!globalChecksumParse.ok) {
                        hasParseError = true;
                        continue;
                    }

                    const wordsPerChecksum = WORDS_PER_ROW;
                    const numRows = recoverWordCount / wordsPerChecksum;
                    const share = {
                        shareNumber,
                        shareIndex,
                        wordShares: [],
                        checksumShares: [],
                        globalChecksumVerificationShare: globalChecksumParse.value
                    };

                    for (let rowIndex = 0; rowIndex < numRows; rowIndex++) {
                        for (let wordSlot = 0; wordSlot < wordsPerChecksum; wordSlot++) {
                            const input = container.querySelector(`input[data-row-index="${rowIndex}"][data-slot="word-${wordSlot}"]`);
                            if (!input) continue;
                            const parseResult = parseShareValue(input.value, { allowNumeric: true });
                            if (!parseResult.ok) {
                                hasParseError = true;
                                break;
                            }
                            share.wordShares.push(parseResult.value);
                        }
                        if (hasParseError) break;

                        const checksumInput = container.querySelector(`input[data-row-index="${rowIndex}"][data-slot="checksum"]`);
                        if (checksumInput) {
                            const checksumParse = parseShareValue(checksumInput.value, { allowNumeric: true });
                            if (!checksumParse.ok) {
                                hasParseError = true;
                                break;
                            }
                            share.checksumShares.push(checksumParse.value);
                        }
                    }

                    if (hasParseError) break;
                    shares.push(share);
                }

                if (hasParseError || shares.length !== k) return;

                // Run validation
                const report = await SchiavinatoSharing.recoverAndValidate(shares, recoverWordCount, BIP39_WORDLIST);

                // Clear all error highlights first
                clearAllErrorHighlights();

                // If all checks passed, we're done - no highlighting needed
                if (report.recoveredMnemonic && 
                    report.errors.failedRows.length === 0 && 
                    !report.errors.globalChecksumError.failed) {
                    return;
                }

                // Show errors silently (no modal)
                if (report.errors.failedRows && report.errors.failedRows.length > 0) {
                    // Highlight row errors
                    report.errors.failedRows.forEach(rowError => {
                        const rowIndex = rowError.rowNumber - 1;  // Convert to 0-based index
                        highlightErrorRow(rowIndex);
                    });
                } else if (report.errors.globalChecksumError && report.errors.globalChecksumError.failed) {
                    // Only highlight global checksum if NO row errors exist (nightmare scenario)
                    highlightGlobalChecksumError();
                }

            } catch (error) {
                // Silently ignore errors - user will see them when they click Recover
            }
        }
        
        /**
         * Clears all error highlighting from input fields
         */
        function clearAllErrorHighlights() {
            const allInputs = document.querySelectorAll('input.invalid');
            allInputs.forEach(input => clearInputErrorState(input));
        }
        
        disclaimerCheckbox.addEventListener('change', () => {
            btnContinueToHome.disabled = !disclaimerCheckbox.checked;
        });
        
        // ==========================================================================
        // SECTION 4: UI - DYNAMIC CONTENT (CREATE & RECOVER FLOWS)
        // ==========================================================================

        /**
         * Explanations for the different schemes.
         */
        const explanations = {
            '2of3': {
                title: '2-of-3: The Smart Standard',
                details: `
                    <p style="margin: 0;"><strong>Best for:</strong> Solo Investors & Personal Backups.</p>
                    <p style="margin: 0;">The "Golden Ratio" of security. It eliminates single points of failure without overcomplicating your life. If your house burns down, you are safe. If a thief steals one share, they have nothing.</p>
                    <p style="margin: 0;"><strong>Loss Tolerance:</strong> You can lose up to <strong>1 share</strong>.</p>
                    <div>
                        <strong>Typical Setup:</strong>
                        <ol style="padding-left: 20px">
                            <li>1. Home Safe (Master Copy)</li>
                            <li>2. Office Drawer or Hidden at Work</li>
                            <li>3. Trusted Family Member's House</li>
                        </ol>
                        <br>
                        <br>
                    </div>`
            },
            '2of4': {
                title: '2-of-4: The Legacy Protocol',
                details: `
                    <p style="margin: 0;"><strong>Best for:</strong> Couples, Families & Inheritance Plans.</p>
                    <p style="margin: 0;">The ultimate safety net for families. Requiring only half the shares, it maximizes forgiveness for error. It ensures heirs can access funds even if multiple locations are lost or destroyed.</p>
                    <p style="margin: 0;"><strong>Loss Tolerance:</strong> You can lose up to <strong>2 shares</strong>.</p>
                    <div>
                        <strong>Typical Setup:</strong>
                        <ol style="padding-left: 20px">
                            <li>1. Your Personal Safe</li>
                            <li>2. Spouse's Personal Safe</li>
                            <li>3. Joint Bank Deposit Box</li>
                            <li>4. Sealed with Family Attorney</li>
                        </ol>
                        <br>
                    </div>`
            },
            '3of5': {
                title: '3-of-5: The Sovereign Fortress',
                details: `
                    <p style="margin: 0;"><strong>Best for:</strong> High Net Worth & Coercion Resistance.</p>
                    <p style="margin: 0;">The ultimate defense against coercion. Forcing access from three separate locations makes it impossible to surrender funds under duress. Your wealth stays secure even if you are targeted personally.</p>
                    <p style="margin: 0;"><strong>Loss Tolerance:</strong> You can lose up to <strong>2 shares</strong>.</p>
                    <div>
                        <strong>Typical Setup:</strong>
                        <ol style="padding-left: 20px">
                            <li>1. Home Safe</li>
                            <li>2. Bank Deposit Box (City A)</li>
                            <li>3. Holiday Home or Office (City B)</li>
                            <li>4. Parents' House / Sibling</li>
                            <li>5. Private Vault or Attorney</li>
                        </ol>
                    </div>`
            }
        };










        /**
         * Updates the scheme explanation box based on the selected radio button.
         */
        function updateSchemeDescription() {
            const selectedValue = document.querySelector('input[name="scheme"]:checked').value;
            const content = explanations[selectedValue];
            schemeExplanation.innerHTML = `${content.details}`;
            if (pages.manualRecovery && pages.manualRecovery.style.display === 'block') {
                updateManualRecoveryShareInputs();
            }
            if (pages.manualSharding && pages.manualSharding.style.display === 'block') {
                updateManualShardingEquation();
            }
        }

        /**
         * Safely parses the current scheme value into threshold (k) and total (n).
         */
        function getSchemeThresholds(schemeValue) {
            if (typeof schemeValue !== 'string') {
                return { k: 2, n: 3 };
            }
            const parts = schemeValue.split('of').map(Number);
            return {
                k: Number.isInteger(parts[0]) ? parts[0] : 2,
                n: Number.isInteger(parts[1]) ? parts[1] : 3
            };
        }

        /**
         * Ensures we have a cached set of share numbers per scheme for the manual recovery helper.
         */
        function ensureManualRecoveryCache(schemeValue, shareCount) {
            if (!manualRecoveryShareCache[schemeValue] || manualRecoveryShareCache[schemeValue].length !== shareCount) {
                manualRecoveryShareCache[schemeValue] = Array(shareCount).fill('');
            }
            return manualRecoveryShareCache[schemeValue];
        }

        /**
         * Displays an inline error message for the manual recovery helper inputs.
         */
        function showManualRecoveryError(message) {
            if (!manualRecoveryErrorBox) return;
            manualRecoveryErrorBox.style.display = 'block';
            manualRecoveryErrorBox.textContent = message;
        }

        /**
         * Clears any inline error message for the manual recovery helper inputs.
         */
        function clearManualRecoveryError() {
            if (!manualRecoveryErrorBox) return;
            manualRecoveryErrorBox.style.display = 'none';
            manualRecoveryErrorBox.textContent = '';
        }

        /**
         * Regenerates the share number inputs for the manual recovery helper when the scheme changes.
         */
        function updateManualRecoveryShareInputs() {
            if (!manualRecoveryShareInputsContainer) return;
            const selectedSchemeRadio = document.querySelector('input[name="scheme"]:checked');
            if (!selectedSchemeRadio) return;
            const schemeValue = selectedSchemeRadio.value;
            const { k } = getSchemeThresholds(schemeValue);
            const cache = ensureManualRecoveryCache(schemeValue, k);

            manualRecoveryShareInputsContainer.innerHTML = '';
            for (let i = 0; i < k; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'form-group';
                const label = document.createElement('label');
                label.htmlFor = `manual-recovery-share-${i + 1}`;
                label.textContent = `Share ${i + 1} number`;
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '1';
                input.max = String(FIELD_PRIME - 1);
                input.id = label.htmlFor;
                input.className = 'mono';
                input.placeholder = 'E.g., 3';
                input.value = cache[i] ?? '';
                input.dataset.fieldLabel = `Share number ${i + 1}`;
                input.dataset.allowNumeric = 'true';
                input.addEventListener('input', (event) => {
                    cache[i] = event.target.value;
                    validateManualRecoveryInputs();
                });
                wrapper.appendChild(label);
                wrapper.appendChild(input);
                manualRecoveryShareInputsContainer.appendChild(wrapper);
            }

            validateManualRecoveryInputs({ quiet: true });
            resetManualRecoveryResults();
        }

        /**
         * Validates the manual recovery helper share numbers and returns the parsed values.
         */
        function validateManualRecoveryInputs(options = {}) {
            const quiet = Boolean(options.quiet);
            if (!manualRecoveryShareInputsContainer) {
                if (btnShowMultipliers) btnShowMultipliers.disabled = true;
                return { ok: false, values: [] };
            }
            const inputs = manualRecoveryShareInputsContainer.querySelectorAll('input');
            const values = [];
            const seen = new Set();
            let errorMessage = '';
            let hasError = false;

            inputs.forEach((input, index) => {
                clearInputErrorState(input);
                const raw = (input.value || '').trim();
                if (!raw) {
                    if (!quiet) {
                        markInputInvalid(input, `Share number ${index + 1} is required.`);
                        if (!errorMessage) errorMessage = 'Enter all share numbers to continue.';
                    }
                    hasError = true;
                    return;
                }
                const numeric = Number(raw);
                if (!Number.isInteger(numeric) || numeric <= 0 || numeric >= FIELD_PRIME) {
                    if (!quiet) {
                        markInputInvalid(input, `Share numbers must be between 1 and ${FIELD_PRIME - 1}.`);
                        if (!errorMessage) errorMessage = `Share numbers must be between 1 and ${FIELD_PRIME - 1}.`;
                    }
                    hasError = true;
                    return;
                }
                if (seen.has(numeric)) {
                    if (!quiet) {
                        markInputInvalid(input, 'Share numbers must be unique.');
                        if (!errorMessage) errorMessage = 'Share numbers must be unique.';
                    }
                    hasError = true;
                    return;
                }
                seen.add(numeric);
                values.push(numeric);
            });

            if (hasError) {
                if (!quiet) {
                    showManualRecoveryError(errorMessage || 'Fix the highlighted fields before continuing.');
                } else {
                    clearManualRecoveryError();
                }
                if (btnShowMultipliers) btnShowMultipliers.disabled = true;
                return { ok: false, values };
            }

            clearManualRecoveryError();
            if (btnShowMultipliers) btnShowMultipliers.disabled = values.length === 0;
            return { ok: values.length > 0, values };
        }

        /**
         * Restores the default placeholder state for the manual recovery multiplier results.
         */
        function resetManualRecoveryResults() {
            if (!manualRecoveryOutputContainer) return;
            manualRecoveryOutputContainer.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-muted); margin: 0;">Enter the share numbers above to see the multipliers.</p>';
        }

        /**
         * Renders the computed Lagrange multipliers for the manual recovery helper.
         */
        function displayManualRecoveryResults(shareNumbers, multipliers) {
            if (!manualRecoveryOutputContainer) return;
            manualRecoveryOutputContainer.innerHTML = '';
            multipliers.forEach((coef, index) => {
                const item = document.createElement('div');
                item.className = 'lagrange-result-item';
                const label = document.createElement('p');
                label.innerHTML = `<strong>Share X = ${shareNumbers[index]}</strong>`;
                const helper = document.createElement('p');
                helper.textContent = `Œª${index + 1}`;
                const code = document.createElement('code');
                code.className = 'mono';
                code.textContent = String(coef).padStart(4, '0');
                item.appendChild(label);
                item.appendChild(helper);
                item.appendChild(code);
                manualRecoveryOutputContainer.appendChild(item);
            });
        }

        /**
         * Generates a fresh polynomial equation for the manual sharding helper using random coefficients.
         */
        function updateManualShardingEquation() {
            if (!polynomialDisplay) return;
            const selectedSchemeRadio = document.querySelector('input[name="scheme"]:checked');
            if (!selectedSchemeRadio) return;
            const schemeValue = selectedSchemeRadio.value;
            const { k } = getSchemeThresholds(schemeValue);
            const degree = Math.max(1, k - 1);
            const coefficients = [];
            const placeholder = '<strong class="mono" style="color: var(--cyber-gold);">&lt;BIP39 word indices&gt;</strong>';
            try {
                for (let i = 0; i < degree; i++) {
                    coefficients.push(SchiavinatoSharing.getRandomFieldElement());
                }
                let equation = `f(X) = ${placeholder}`;
                coefficients.forEach((coef, index) => {
                    const exponent = index + 1;
                    const power = exponent === 1 ? 'X' : `X<sup>${exponent}</sup>`;
                    equation += ` + ${coef} * ${power}`;
                });
                polynomialDisplay.innerHTML = `<code class="mono" style="font-size: 1.1rem; word-wrap: break-word;">${equation}</code>`;
            } catch (error) {
                polynomialDisplay.innerHTML = `<span style="color: var(--error-red);">Error: Could not generate secure random numbers.</span>`;
            }
        }

        /**
         * Generates the seed word input fields for the Create page, using the cache.
         */
        function updateSeedWordInputs() {
            // 1. Take a "snapshot" of the currently visible inputs and save to the cache.
            const existingInputs = seedWordInputsContainer.querySelectorAll('input');
            existingInputs.forEach((input, index) => {
                if (index < createFlowWordCache.length) {
                    createFlowWordCache[index] = input.value;
                }
            });

            // 2. Clear and regenerate inputs.
            seedWordInputsContainer.innerHTML = ''; 
            for (let i = 1; i <= createWordCount; i++) {
                const row = document.createElement('div');
                row.className = 'seed-word-row';
                const label = document.createElement('label');
                label.htmlFor = `word-${i}`;
                label.textContent = `${i}.`;
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `word-${i}`;
                input.className = 'mono';
                input.value = createFlowWordCache[i - 1] || ''; // 3. Restore from cache.
                attachAutocompleteListeners(input);
                row.appendChild(label);
                row.appendChild(input);
                seedWordInputsContainer.appendChild(row);
            }

            const wordInputs = seedWordInputsContainer.querySelectorAll('input');
            if (wordInputs.length > 0) {
                const lastWordInput = wordInputs[wordInputs.length - 1];
                attachTabAdvance(lastWordInput, btnGenerateShares);
            }
        }
        
        schemeRadios.forEach(radio => radio.addEventListener('change', updateSchemeDescription));
        
        /**
         * Generates a complete HTML block for a single share's input fields from the cache.
         * @param {number} shareIndex - The index of the share to generate (1-based).
         * @returns {HTMLElement} The fully constructed div element for the share input.
         */
        function generateSingleRecoverShareInput(shareIndex) {
            const cacheIndex = shareIndex - 1;
            const shareCache = recoverFlowCache[cacheIndex];

            const container = document.createElement('div');
            container.className = 'share-input-container';
            container.id = `share-container-${shareIndex}`;
            container.dataset.shareIndex = String(shareIndex);

            const mainHeader = document.createElement('h3');
            mainHeader.textContent = `Share Input #${shareIndex}`;
            container.appendChild(mainHeader);

            const twoColGrid = document.createElement('div');
            twoColGrid.style.display = 'grid';
            twoColGrid.style.gridTemplateColumns = '1fr 1fr';
            twoColGrid.style.gap = '20px';

            const shareNumberGroup = document.createElement('div');
            shareNumberGroup.className = 'form-group';
            const labelX = document.createElement('label');
            labelX.htmlFor = `recover-x-${shareIndex}`;
            labelX.textContent = `Share Number (X)`;
            const inputX = document.createElement('input');
            inputX.type = 'text';
            inputX.id = `recover-x-${shareIndex}`;
            inputX.className = 'mono';
            inputX.placeholder = 'E.g., 3';
            inputX.value = shareCache.shareNumber;
            inputX.dataset.allowNumeric = 'true';
            inputX.dataset.fieldLabel = `Share ${shareIndex} number`;
            initializeRecoveryInputTracking(inputX);
            inputX.addEventListener('blur', () => {
                validateInputOnBlur(inputX);
                attemptAutoValidation();
            });
            inputX.addEventListener('input', () => clearInputErrorState(inputX));
            shareNumberGroup.appendChild(labelX);
            shareNumberGroup.appendChild(inputX);
            twoColGrid.appendChild(shareNumberGroup);

            const globalChecksumShareGroup = document.createElement('div');
            globalChecksumShareGroup.className = 'form-group';
            const labelGlobalChecksum = document.createElement('label');
            labelGlobalChecksum.htmlFor = `recover-global-checksum-${shareIndex}`;
            labelGlobalChecksum.textContent = `Global Checksum`;
            const inputGlobalChecksum = document.createElement('input');
            inputGlobalChecksum.type = 'text';
            inputGlobalChecksum.id = `recover-global-checksum-${shareIndex}`;
            inputGlobalChecksum.className = 'mono';
            inputGlobalChecksum.placeholder = 'E.g., abandon - 0001';
            inputGlobalChecksum.value = shareCache.globalChecksumVerificationShare || '';
            inputGlobalChecksum.dataset.allowNumeric = 'true';
            inputGlobalChecksum.dataset.fieldLabel = `Share ${shareIndex} global checksum verification`;
            initializeRecoveryInputTracking(inputGlobalChecksum);
            attachAutocompleteListeners(inputGlobalChecksum);
            globalChecksumShareGroup.appendChild(labelGlobalChecksum);
            globalChecksumShareGroup.appendChild(inputGlobalChecksum);
            twoColGrid.appendChild(globalChecksumShareGroup);
            
            container.appendChild(twoColGrid);

            const seedGrid = document.createElement('div');
            seedGrid.style.display = 'grid';
            seedGrid.style.gridTemplateColumns = 'repeat(4, 1fr)';
            seedGrid.style.gap = '15px';

            const totalWords = recoverWordCount;
            const wordsPerChecksum = 3;
            const numChecksums = totalWords / wordsPerChecksum;

            let wordCounter = 0;
            let inputIndex = 0;
            for (let i = 1; i <= numChecksums; i++) {
                for (let j = 0; j < wordsPerChecksum; j++) {
                    const row = document.createElement('div');
                    row.className = 'seed-word-row';
                    const label = document.createElement('label');
                    const wordNumber = (i - 1) * wordsPerChecksum + j + 1;
                    label.textContent = `${wordNumber}.`;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'mono';
                    input.id = buildRecoveryFieldId(shareIndex, i - 1, `word-${j}`);
                    input.dataset.shareIndex = String(shareIndex);
                    input.dataset.rowIndex = String(i - 1);
                    input.dataset.slot = `word-${j}`;
                    input.dataset.allowNumeric = 'true';
                    input.dataset.fieldLabel = buildRecoveryFieldLabel(shareIndex, i - 1, `word-${j}`);
                    input.value = shareCache.words[wordCounter] || '';
                    initializeRecoveryInputTracking(input);
                    attachAutocompleteListeners(input);
                    row.appendChild(label);
                    row.appendChild(input);
                    seedGrid.appendChild(row);
                    wordCounter++;
                    inputIndex++;
                }
                const row = document.createElement('div');
                row.className = 'seed-word-row';
                const label = document.createElement('label');
                label.textContent = `C${i}.`;
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'mono';
                input.id = buildRecoveryFieldId(shareIndex, i - 1, 'checksum');
                input.dataset.shareIndex = String(shareIndex);
                input.dataset.rowIndex = String(i - 1);
                input.dataset.slot = 'checksum';
                input.dataset.allowNumeric = 'true';
                input.dataset.fieldLabel = buildRecoveryFieldLabel(shareIndex, i - 1, 'checksum');
                input.value = shareCache.words[wordCounter] || '';
                initializeRecoveryInputTracking(input);
                attachAutocompleteListeners(input);
                row.appendChild(label);
                row.appendChild(input);
                seedGrid.appendChild(row);
                wordCounter++;
                inputIndex++;
            }

            container.appendChild(seedGrid);
            return container;
        }

        /**
         * Clears and regenerates all share input blocks based on the selected K value.
         */
        function updateRecoverSharesInputs() {
            // 1. Take a "snapshot" of the current UI state and save it to the cache.
            const existingContainers = recoverSharesContainer.querySelectorAll('.share-input-container');
            existingContainers.forEach((container) => {
                const shareNumberInput = container.querySelector('[id^="recover-x-"]');
                const globalChecksumShareInput = container.querySelector('[id^="recover-global-checksum-"]');
                if (!shareNumberInput) return;
                
                const shareIndex = parseInt(shareNumberInput.id.split('-').pop(), 10) - 1;
                const cacheEntry = recoverFlowCache[shareIndex];
                
                if (cacheEntry) {
                    cacheEntry.shareNumber = shareNumberInput.value;
                    cacheEntry.globalChecksumVerificationShare = globalChecksumShareInput.value;
                    const wordInputs = container.querySelectorAll('.seed-word-row input');
                    wordInputs.forEach((input, wordIndex) => {
                        if (wordIndex < cacheEntry.words.length) {
                            cacheEntry.words[wordIndex] = input.value;
                        }
                    });
                }
            });

            // 2. Clear and regenerate the UI.
            recoverSharesContainer.innerHTML = '';
            const kValue = document.querySelector('input[name="recover-k"]:checked').value;
            const numShares = parseInt(kValue, 10);
            for (let i = 1; i <= numShares; i++) {
                const shareInputBlock = generateSingleRecoverShareInput(i);
                recoverSharesContainer.appendChild(shareInputBlock);
            }

            const recoverWordInputs = recoverSharesContainer.querySelectorAll('.seed-word-row input');
            if (recoverWordInputs.length > 0) {
                const lastRecoverWordInput = recoverWordInputs[recoverWordInputs.length - 1];
                attachTabAdvance(lastRecoverWordInput, btnRecoverWallet);
            }
        }

        recoverKRadios.forEach(radio => radio.addEventListener('change', updateRecoverSharesInputs));
        
        // ==========================================================================
        // SECTION 5: UI - AUTOCOMPLETE & VALIDATION
        // ==========================================================================

        /**
         * Attaches all necessary event listeners for autocomplete and validation to an input field.
         * @param {HTMLInputElement} input - The input element.
         */
        function attachAutocompleteListeners(input) {
            input.addEventListener('input', () => {
                currentAutocompleteInput = input;
                showAutocomplete(input);
                // Provide immediate, lenient feedback as the user types.
                validateInputAsUserTypes(input);
            });
            input.addEventListener('keydown', handleAutocompleteKeydown);
            attachValidationListener(input); // Also attach the blur validation
        }

        /**
         * Forces the Tab key on the provided input to focus the supplied target element.
         * @param {HTMLInputElement} input
         * @param {HTMLElement} targetElement
         */
        function attachTabAdvance(input, targetElement) {
            if (!input || !targetElement) return;
            input.addEventListener('keydown', (event) => {
                if (
                    event.key === 'Tab' &&
                    !event.shiftKey &&
                    !event.altKey &&
                    !event.ctrlKey &&
                    !event.metaKey
                ) {
                    event.preventDefault();
                    targetElement.focus();
                }
            });
        }

        /**
         * Attaches only the blur validation listener to an input field.
         * This uses a stricter validation than the live input validation.
         * @param {HTMLInputElement} input - The input element.
         */
        function attachValidationListener(input) {
             input.addEventListener('blur', () => {
                setTimeout(() => {
                    if (!autocompleteContainer.contains(document.activeElement)) {
                        hideAutocomplete();
                        validateInputOnBlur(input);
                        attemptAutoValidation();
                    }
                }, 150);
            });
        }

        /**
         * Validates input leniently as the user types. An input is only invalid
         * if it's not a valid prefix of any word in the list. This prevents
         * showing an error while the user is still typing a valid word.
         * @param {HTMLInputElement} input
         */
        function validateInputAsUserTypes(input) {
            const value = input.value.trim();
            const normalizedValue = value.toLowerCase();

            if (normalizedValue === '') {
                input.classList.remove('invalid');
                return;
            }

            const allowNumeric = input.dataset.allowNumeric === 'true';
            const isPrefix = BIP39_WORDLIST.some(word => word.startsWith(normalizedValue));
            const isValid = allowNumeric ? true : isPrefix;
            
            if (isValid) {
                input.classList.remove('invalid');
            } else {
                input.classList.add('invalid');
            }
        }

        /**
         * Validates input strictly when the user leaves the field (on blur).
         * The input must be a full, valid BIP39 word or a parsable share value.
         * Prefixes are not considered valid here.
         * @param {HTMLInputElement} input
         */
        function validateInputOnBlur(input) {
            const allowNumeric = input.dataset.allowNumeric === 'true';
            const parseResult = parseShareValue(input.value, { allowNumeric });
            if (parseResult.ok || (input.value || '').trim() === '') {
                clearInputErrorState(input);
                return parseResult.ok ? parseResult.value : null;
            }
            const label = input.dataset.fieldLabel || 'This field';
            markInputInvalid(input, formatParseError(label, parseResult), { rowHighlight: input.hasAttribute('data-row-highlight') });
            return null;
        }

        /**
         * Displays and positions the autocomplete suggestion box, preferring side placement
         * and intelligently adjusting vertically to stay within the viewport.
         * @param {HTMLInputElement} input - The input element to position against.
         */
        function showAutocomplete(input) {
            const value = input.value.toLowerCase().trim();
            if (!value) {
                hideAutocomplete();
                return;
            }

            const suggestions = BIP39_WORDLIST.filter(word => word.startsWith(value));
            if (suggestions.length === 0) {
                hideAutocomplete();
                return;
            }

            autocompleteContainer.innerHTML = '';
            autocompleteContainer.addEventListener('mousemove', () => {
                allowMouseHover = true;
            }, { once: true });

            suggestions.forEach((word, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-suggestion';
                item.textContent = word;
                item.addEventListener('click', () => {
                    input.value = word;
                    hideAutocomplete();
                    validateInput(input);
                });
                item.addEventListener('mouseenter', () => {
                    if (allowMouseHover) {
                        activeSuggestionIndex = index;
                        const suggestionElements = autocompleteContainer.querySelectorAll('.autocomplete-suggestion');
                        updateActiveSuggestion(suggestionElements);
                    }
                });
                autocompleteContainer.appendChild(item);
            });
            
            const suggestionElements = autocompleteContainer.querySelectorAll('.autocomplete-suggestion');
            if (suggestionElements.length === 1) {
                activeSuggestionIndex = 0;
                updateActiveSuggestion(suggestionElements);
            } else {
                activeSuggestionIndex = -1;
            }

            const GAP = 8;
            const VIEWPORT_PADDING = 10;
            
            autocompleteContainer.style.visibility = 'hidden';
            autocompleteContainer.style.display = 'block';
            const suggestionsHeight = autocompleteContainer.offsetHeight;
            const suggestionsWidth = autocompleteContainer.offsetWidth;

            const rect = input.getBoundingClientRect();
            let top, left;

            const canFitRight = rect.right + GAP + suggestionsWidth < window.innerWidth - VIEWPORT_PADDING;
            const canFitLeft = rect.left - GAP - suggestionsWidth > VIEWPORT_PADDING;

            let adjustedTop = rect.top;
            if (adjustedTop + suggestionsHeight > window.innerHeight - VIEWPORT_PADDING) {
                adjustedTop = window.innerHeight - suggestionsHeight - VIEWPORT_PADDING;
            }
            adjustedTop = Math.max(VIEWPORT_PADDING, adjustedTop);

            if (canFitRight) {
                left = rect.right + GAP;
                top = adjustedTop;
            } else if (canFitLeft) {
                left = rect.left - suggestionsWidth - GAP;
                top = adjustedTop;
            } else {
                const spaceBelow = window.innerHeight - rect.bottom;
                if (spaceBelow > suggestionsHeight || spaceBelow > rect.top) {
                    top = rect.bottom;
                } else {
                    top = rect.top - suggestionsHeight;
                }
                left = rect.left;
            }

            autocompleteContainer.style.top = `${top + window.scrollY}px`;
            autocompleteContainer.style.left = `${left + window.scrollX}px`;
            autocompleteContainer.style.width = suggestionsWidth ? `${suggestionsWidth}px` : 'auto';
            autocompleteContainer.style.visibility = 'visible';
        }

        /** Hides the autocomplete suggestion box and resets its state. */
        function hideAutocomplete() {
            autocompleteContainer.style.display = 'none';
            currentAutocompleteInput = null;
            allowMouseHover = false;
        }

        /**
         * Handles keyboard navigation (arrows, Enter, Escape, Tab) for the autocomplete box.
         * @param {KeyboardEvent} e - The keydown event.
         */
        function handleAutocompleteKeydown(e) {
            const suggestions = autocompleteContainer.querySelectorAll('.autocomplete-suggestion');
            if (suggestions.length === 0 || autocompleteContainer.style.display === 'none') return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeSuggestionIndex++;
                if (activeSuggestionIndex >= suggestions.length) activeSuggestionIndex = 0;
                updateActiveSuggestion(suggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeSuggestionIndex--;
                if (activeSuggestionIndex < 0) activeSuggestionIndex = suggestions.length - 1;
                updateActiveSuggestion(suggestions);
            } else if (e.key === 'Enter' || e.key === 'Tab') {
                if (activeSuggestionIndex > -1) {
                    e.preventDefault();
                    suggestions[activeSuggestionIndex].click();
                }
            } else if (e.key === 'Escape') {
                e.preventDefault();
                hideAutocomplete();
            }
        }
        
        /**
         * Updates the visual state of the active suggestion for keyboard navigation.
         * @param {NodeListOf<Element>} suggestions - The list of suggestion elements.
         */
        function updateActiveSuggestion(suggestions) {
            suggestions.forEach((item, index) => {
                item.classList.toggle('autocomplete-active', index === activeSuggestionIndex);
            });
        }
        
        /**
         * Validates an input's value on blur.
         * A valid input can be a BIP39 word, a number in the field, or a "word - number" pair.
         * @param {HTMLInputElement} input - The input element to validate.
         */
        function validateInput(input) {
            if ((input.value || '').trim() === '') {
                clearInputErrorState(input);
                return null;
            }
            return validateInputOnBlur(input);
        }

        /**
         * Clears any prior checksum-row highlights applied during recovery attempts.
         */
        function clearAllRecoveryHighlights() {
            const highlighted = recoverSharesContainer.querySelectorAll('[data-row-highlight="true"]');
            highlighted.forEach(input => {
                input.classList.remove('invalid');
                input.removeAttribute('data-row-highlight');
                const container = input.closest('.share-input-container');
                if (container) {
                    container.style.borderColor = ''; // Reset border to default
                }
            });
        }

        /**
         * Highlights all inputs for a specific row in a specific share container.
         * Used for pre-flight validation where the faulty share is known.
         * @param {number} shareIndex - The 1-based index of the share container.
         * @param {number} rowIndex - The 0-based index of the row to highlight.
         */
        function highlightShareRow(shareIndex, rowIndex) {
            const container = document.getElementById(`share-container-${shareIndex}`);
            if (!container) return;
            const inputs = container.querySelectorAll(`input[data-row-index="${rowIndex}"]`);
            inputs.forEach(input => markInputInvalid(input, input.dataset.fieldLabel || 'Row value mismatch', { rowHighlight: true }));
        }

        /**
         * Highlights all inputs in the specified row across all shares.
         * Note: We cannot determine which specific share has an error, so we highlight all.
         * @param {number} rowIndex - Zero-based index of the row to highlight.
         */
        function highlightErrorRow(rowIndex) {
            if (typeof rowIndex !== 'number' || rowIndex < 0) return;
            const shareContainers = recoverSharesContainer.querySelectorAll('.share-input-container');
            
            shareContainers.forEach(container => {
                const inputs = container.querySelectorAll(`input[data-row-index="${rowIndex}"]`);
                inputs.forEach(input => {
                    markInputInvalid(input, 'Check this field', { rowHighlight: true });
                });
            });
        }
        
        /**
         * Marks all "Global Checksum Verification" input fields as invalid.
         * Note: We cannot determine which specific share has an error, so we highlight all.
         */
        function highlightGlobalChecksumError() {
            const globalChecksumInputs = document.querySelectorAll('[id^="recover-global-checksum-"]');
            
            globalChecksumInputs.forEach(input => {
                const label = input.dataset.fieldLabel || 'Global Checksum verification';
                markInputInvalid(input, `${label} failed. Check all global checksum fields.`, { rowHighlight: true });
            });
        }

        // ==========================================================================
        // SECTION 6: UI - MODALS & DIALOGS
        // ==========================================================================

        let modalResolve = null;

        /**
         * Displays a custom confirmation modal and returns a promise that resolves on user action.
         * @param {string} title - The title to display in the modal.
         * @param {string} text - The body text to display in the modal.
         * @returns {Promise<boolean>} A promise that resolves to `true` if confirmed, `false` otherwise.
         */
        function showConfirmationModal(title, text) {
            modalTitle.textContent = title;
            modalText.textContent = text;
            modal.style.display = 'flex';
            return new Promise((resolve) => {
                modalResolve = resolve;
            });
        }

        /**
         * A wrapper for `showConfirmationModal` tailored for displaying error messages.
         * @param {string} title - The title of the error.
         * @param {string} text - The detailed error message.
         * @returns {Promise<void>} A promise that resolves when the user dismisses the modal.
         */
        function showErrorModal(title, text) {
            modalTitle.textContent = title;
            modalText.textContent = text;
            modalConfirmBtn.textContent = 'OK';
            modalCancelBtn.style.display = 'none';
            modal.style.display = 'flex';

            return new Promise((resolve) => {
                modalResolve = resolve; // This will be resolved as `true` by the existing listener
            });
        }

        modalConfirmBtn.addEventListener('click', () => {
            if (modalResolve) modalResolve(true);
            modal.style.display = 'none';
            // Reset modal to its default confirmation state after use
            modalConfirmBtn.textContent = 'Confirm';
            modalCancelBtn.style.display = 'inline-block';
        });

        modalCancelBtn.addEventListener('click', () => {
            if (modalResolve) modalResolve(false);
            modal.style.display = 'none';
        });

        /**
         * Dynamically generates and displays the share cards on Page 2.
         * @param {Array<Object>} shares - The array of generated share data.
         * @param {Object} metadata - The wallet metadata from the form.
         */
        function displayShares(shares, metadata) {
            const outputContainer = document.getElementById('shares-output');
            const printContainer = document.getElementById('print-output');
            
            const [k, n] = metadata.scheme.split('of').map(Number);

            const manualRecoveryInstructions = `
                <div class="component-card" style="margin-top: 2rem; border-style: dashed; page-break-inside: avoid;">
                    <h4>Manual Recovery Instructions (Pencil & Paper)</h4>
                    <p style="font-size: 0.8rem; color: var(--text-muted); text-align: left;">
                        These instructions explain how to recover the original wallet phrase without a computer, using only the numbers from your share sheets. You will need at least <strong>${k} different share sheets</strong> from this set to proceed. All calculations are performed "modulo 2053", which means you divide by 2053 and take the remainder.
                    </p>
                    <ol style="font-size: 0.8rem; padding-left: 20px; text-align: left;">
                        <li style="margin-bottom: 0.5em;">
                            <strong>Find Lagrange Coefficients (Œ≥):</strong> For the specific set of Share Numbers you have (e.g., #1, #2), you need a corresponding set of "Lagrange Coefficients". These are non-secret numbers. You can find them in the Schiavinato Sharing whitepaper for common schemes or generate them with the official tool. You will have one coefficient for each share you are using.
                        </li>
                        <li style="margin-bottom: 0.5em;">
                            <strong>Recover One Number:</strong> To recover a single original number (e.g., for position #1), take the numeric value (Y) from that position on each of your ${k} share sheets. Multiply each Y value by its corresponding Lagrange Coefficient (Œ≥). Sum all the results. The remainder of this sum when divided by 2053 is the recovered secret number.
                            <br><em>Formula: (Y‚ÇÅ¬∑Œ≥‚ÇÅ + Y‚ÇÇ¬∑Œ≥‚ÇÇ + ...) mod 2053 = Secret</em>
                        </li>
                        <li style="margin-bottom: 0.5em;">
                            <strong>Recover and Verify Each Row:</strong> Repeat step 2 for all three word values and the checksum value in a single row. Then, verify your math: add your three recovered word numbers together (modulo 2053). The result MUST equal your recovered checksum number for that row. If it doesn't, you have made a calculation error in that row.
                        </li>
                        <li style="margin-bottom: 0.5em;">
                            <strong>Final Global Checksum Verification:</strong> After all rows are recovered and verified, use the same method from step 2 to recover the "Global Checksum Verification Number" from the share headers. Then, add all 24 of your recovered word numbers together (modulo 2053). The result MUST equal the recovered Global Checksum Verification Number. If it doesn't, an error exists in one or more rows.
                        </li>
                        <li style="margin-bottom: 0.5em;">
                            <strong>Convert to Words:</strong> Once all checks pass, use the standard BIP39 wordlist to look up the word for each of your 12-24 recovered numbers. The resulting sequence of 12-24 words is your wallet's original recovery phrase.
                        </li>
                    </ol>
                </div>
            `;

            let allSharesScreenHtml = '';
            let allSharesPrintHtml = '';

            shares.forEach(share => {
                const globalChecksumValue = share.globalChecksumVerificationShare;
                const globalChecksumWord = globalChecksumValue < 2048 ? BIP39_WORDLIST[globalChecksumValue] : String(globalChecksumValue);
                const globalChecksumShareDisplay = `${globalChecksumWord} - ${String(globalChecksumValue).padStart(4, '0')}`;

                let wordListHtml = '';
                let wordCounter = 0;
                for (let i = 0; i < (metadata.wordCount / 3); i++) {
                    for (let j = 0; j < 3; j++) {
                        const value = share.wordShares[wordCounter];
                        const word = value < 2048 ? BIP39_WORDLIST[value] : String(value);
                        const display = `${word} - ${String(value).padStart(4, '0')}`;
                        wordListHtml += `<div class="share-word-item"><label>${wordCounter + 1}.</label><code class="mono">${display}</code></div>`;
                        wordCounter++;
                    }
                    const checksumValue = share.checksumShares[i];
                    const checksumWord = checksumValue < 2048 ? BIP39_WORDLIST[checksumValue] : String(checksumValue);
                    const checksumDisplay = `${checksumWord} - ${String(checksumValue).padStart(4, '0')}`;
                    wordListHtml += `<div class="share-word-item"><label>C${i + 1}.</label><code class="mono">${checksumDisplay}</code></div>`;
                }

                const shareContentHtml = `
                    <h3>Share ${share.shareNumber} of ${n}</h3>
                    <hr>
                    <div class="share-metadata">
                        <p><strong>Wallet Identifier:</strong> ${metadata.identifier}</p>
                        <p><strong>Creation Date:</strong> ${metadata.date}</p>
                        <p><strong>Scheme:</strong> ${metadata.scheme}</p>
                        <p><strong>Share Number (X):</strong> ${share.shareNumber}</p>
                        <p><strong>Global Checksum:</strong> <code class="mono">${globalChecksumShareDisplay}</code></p>
                    </div>
                    <h4 style="margin-top: 25px; margin-bottom: 10px; color: var(--text-muted); font-weight: 600;">Share Values (Y)</h4>
                    <div class="share-word-container">
                        <div class="share-word-list">${wordListHtml}</div>
                    </div>
                `;

                const printWarningHtml = `
                    <div style="text-align: center; padding: 5px; border: 1px solid var(--error-red); background: var(--alert-error-bg); border-radius: 8px; margin-bottom: 1rem;">
                        <strong style="color: var(--error-red);">This is 1 of ${n} shares. It CANNOT recover funds alone. Do NOT enter these words into a wallet.</strong>
                    </div>
                `;

                allSharesScreenHtml += `<div class="component-card share-card">${shareContentHtml}</div>`;
                allSharesPrintHtml += `<div class="component-card share-card">${printWarningHtml}${shareContentHtml}${manualRecoveryInstructions}</div>`;
            });

            outputContainer.innerHTML = allSharesScreenHtml;
            printContainer.innerHTML = allSharesPrintHtml;
        }

        /**
         * Dynamically generates and displays the recovered mnemonic on Page 4.
         * @param {string} mnemonic - The recovered BIP39 mnemonic string.
         * @param {boolean} [showWarning=false] - If true, displays a permanent warning.
         */
        function displayRecoveredMnemonic(mnemonic, showWarning = false) {
            const words = mnemonic.split(' ');
            const container = document.querySelector('#pageRecover2 .share-word-list');
            const pageContainer = document.getElementById('pageRecover2');
            if (!container || !pageContainer) return;

            // Clear previous results and warnings
            container.innerHTML = ''; 
            const existingWarning = pageContainer.querySelector('.alert-error');
            if (existingWarning) {
                existingWarning.remove();
            }

            if (showWarning) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'alert alert-error';
                warningDiv.innerHTML = '<strong>WARNING: INVALID SEED.</strong> This recovery phrase has an incorrect BIP39 checksum. DO NOT use it to store funds.';
                // Insert warning before the component card containing the seed phrase
                const targetCard = pageContainer.querySelector('.component-card:nth-of-type(2)');
                if(targetCard) {
                    targetCard.insertAdjacentElement('beforebegin', warningDiv);
                }
            }

            words.forEach((word, index) => {
                const item = document.createElement('div');
                item.className = 'share-word-item';
                const label = document.createElement('label');
                label.textContent = `${index + 1}.`;
                const code = document.createElement('code');
                code.className = 'mono';
                code.textContent = word;
                item.appendChild(label);
                item.appendChild(code);
                container.appendChild(item);
            });

            // Adjust grid columns based on word count for better layout
            const columns = 3;
            container.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
        }

        // ==========================================================================
        // SECTION 7: UI - EVENT LISTENERS & INITIALIZATION
        // ==========================================================================
        
        if (themeToggleBtn) {
            themeToggleBtn.addEventListener('click', toggleTheme);
        }
        if (btnPrintShares) {
            btnPrintShares.addEventListener('click', () => window.print());
        }
        if (btnPrintRecovered) {
            btnPrintRecovered.addEventListener('click', () => window.print());
        }
        
        /**
         * Sets up the event listeners and class toggling for a pair of 12/24 word buttons.
         * @param {HTMLButtonElement} btn12 - The 12-words button.
         * @param {HTMLButtonElement} btn24 - The 24-words button.
         * @param {function(number): void} wordCountCallback - A function to call with the new word count.
         * @param {function(): void} updateFn - The function to call to regenerate the inputs.
         */
        function setupWordToggle(btn12, btn24, wordCountCallback, updateFn) {
            btn12.addEventListener('click', () => {
                wordCountCallback(12);
                btn12.classList.add('btn-primary');
                btn12.classList.remove('btn-secondary');
                btn24.classList.add('btn-secondary');
                btn24.classList.remove('btn-primary');
                updateFn();
            });
            btn24.addEventListener('click', () => {
                wordCountCallback(24);
                btn24.classList.add('btn-primary');
                btn24.classList.remove('btn-secondary');
                btn12.classList.add('btn-secondary');
                btn12.classList.remove('btn-primary');
                updateFn();
            });
        }
        
        /**
         * Attaches a confirmation dialog to a "start over" button.
         * @param {HTMLButtonElement} button - The button to attach the listener to.
         * @param {string} title - The title for the confirmation modal.
         * @param {string} text - The descriptive text for the confirmation modal.
         */
        function setupStartOverButton(button, title, text) {
            button.addEventListener('click', async () => {
                const confirmed = await showConfirmationModal(title, text);
                if (confirmed) {
                    // Security: Clear all input fields before reloading to reduce memory dump risk
                    cleanupSensitiveInputs();
                    window.location.reload();
                }
            });
        }
        
        /**
         * Clears all potentially sensitive input fields in the DOM.
         * This reduces the window of vulnerability to memory dump attacks.
         */
        function cleanupSensitiveInputs() {
            // Clear all text inputs, textareas, and any displayed mnemonics
            const allInputs = document.querySelectorAll('input[type="text"], input[type="password"], textarea');
            allInputs.forEach(input => {
                if (input.value) {
                    input.value = '';
                }
            });
            
            // Clear any displayed mnemonic words
            const mnemonicContainers = document.querySelectorAll('.share-word-list, .share-word-item code');
            mnemonicContainers.forEach(container => {
                if (container.textContent) {
                    container.textContent = '';
                }
            });
            
            // Clear cached data in memory
            createFlowWordCache = Array(24).fill('');
            recoverFlowCache = Array(MAX_SHARES).fill(null).map(() => ({
                shareNumber: '',
                words: Array(24).fill(''),
                checksums: Array(8).fill(''),
                globalChecksum: ''
            }));
            
            // Clear autocomplete cache
            if (typeof manualRecoveryShareCache !== 'undefined') {
                Object.keys(manualRecoveryShareCache).forEach(key => {
                    manualRecoveryShareCache[key] = [];
                });
            }
        }
        
        setupWordToggle(btn12Words, btn24Words, (count) => { createWordCount = count; }, updateSeedWordInputs);
        setupWordToggle(recoverBtn12Words, recoverBtn24Words, (count) => { recoverWordCount = count; }, updateRecoverSharesInputs);
        
        setupStartOverButton(
            btnStartOverCreate,
            'Are you sure?',
            'All entered data and generated shares will be lost forever. This action cannot be undone.'
        );
        setupStartOverButton(
            btnStartOverRecover,
            'Are you sure?',
            'All recovered data will be lost forever. This action cannot be undone.'
        );

        // DOMContentLoaded Listener (App Initialization)
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('creation-date').valueAsDate = new Date();
            
            updateSchemeDescription();
            updateSeedWordInputs();
            updateRecoverSharesInputs();

            // Set initial theme based on user's system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                toggleTheme();
            }
        });

        // ==========================================================================
        // SECTION 8: UI - THEME TOGGLE & HELPERS
        // ==========================================================================
        
        /**
         * Toggles the 'data-theme' attribute on the body to switch between themes.
         */
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('toggle-icon');
            const text = document.getElementById('toggle-text');
            if (body.getAttribute('data-theme') === 'light') {
                body.removeAttribute('data-theme');
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = 'Light Mode';
            } else {
                body.setAttribute('data-theme', 'light');
                icon.textContent = 'üåô';
                text.textContent = 'Dark Mode';
            }
        }

        // ==========================================================================
        //
    </script>

    <script>
        // ==========================================================================
        // SCHIAVINATO SHARING LIBRARY (Embedded for offline use)
        // - This object contains all core cryptographic and validation logic.
        // - It is self-contained and has no dependencies on the DOM or UI scripts.
        // ==========================================================================
        const SchiavinatoSharing = (function() {
            'use strict';

            // ==========================================================================
            // CONSTANTS & CONFIG
            // ==========================================================================
            const FIELD_PRIME = 2053;
            const WORDS_PER_ROW = 3;

            const GLOBAL_SCOPE = typeof globalThis !== 'undefined'
                ? globalThis
                : (typeof self !== 'undefined' ? self : (typeof window !== 'undefined' ? window : {}));
            let randomSource = (GLOBAL_SCOPE.crypto && typeof GLOBAL_SCOPE.crypto.getRandomValues === 'function')
                ? GLOBAL_SCOPE.crypto
                : null;
            let sha256Impl = (typeof GLOBAL_SCOPE.sha256 === 'function') ? GLOBAL_SCOPE.sha256 : null;

            /**
             * Allows callers to override the randomness provider and/or SHA-256 implementation.
             * Useful for non-browser environments or deterministic tests.
             * @param {Object} [options]
             * @param {{getRandomValues: function(Uint32Array): void}} [options.randomSource]
             * @param {Function} [options.sha256]
             */
            function configureEnvironment(options = {}) {
                const { randomSource: newRandomSource, sha256: newSha256 } = options;
                if (newRandomSource !== undefined) {
                    if (!newRandomSource || typeof newRandomSource.getRandomValues !== 'function') {
                        throw new Error('randomSource must expose getRandomValues(Uint32Array).');
                    }
                    randomSource = newRandomSource;
                }
                if (newSha256 !== undefined) {
                    if (typeof newSha256 !== 'function' || typeof newSha256.arrayBuffer !== 'function') {
                        throw new Error('sha256 must have a callable arrayBuffer(message) helper.');
                    }
                    sha256Impl = newSha256;
                }
            }

            // ==========================================================================
            // SECURITY UTILITIES
            // ==========================================================================
            /**
             * Constant-time equality comparison for field elements.
             * Prevents timing attacks by avoiding early exit on mismatch.
             * Uses bitwise XOR to compare values without branching on bit differences.
             * @param {number} a - First value to compare
             * @param {number} b - Second value to compare
             * @returns {boolean} true if values are equal, false otherwise
             */
            function constantTimeEqual(a, b) {
                const diff = a ^ b;
                return diff === 0;
            }

            /**
             * Constant-time string equality comparison.
             * Compares strings character by character without early exit,
             * preventing timing attacks on string comparisons (e.g., BIP39 checksums).
             * @param {string} a - First string to compare
             * @param {string} b - Second string to compare
             * @returns {boolean} true if strings are equal, false otherwise
             */
            function constantTimeStringEqual(a, b) {
                const maxLen = Math.max(a.length, b.length);
                let diff = a.length ^ b.length;
                
                for (let i = 0; i < maxLen; i++) {
                    const charA = i < a.length ? a.charCodeAt(i) : 0;
                    const charB = i < b.length ? b.charCodeAt(i) : 0;
                    diff |= charA ^ charB;
                }
                
                return diff === 0;
            }

            /**
             * Securely overwrites an array with zeros.
             * Reduces the window of vulnerability to memory dump attacks by
             * explicitly clearing sensitive data instead of relying on garbage collection.
             * @param {Array} arr - Array to wipe (will be modified in place)
             */
            function secureWipeArray(arr) {
                if (Array.isArray(arr)) {
                    for (let i = 0; i < arr.length; i++) {
                        arr[i] = 0;
                    }
                }
            }

            /**
             * Attempts to overwrite a string variable by reassigning it to zeros.
             * Note: JavaScript strings are immutable, so this has limited effectiveness.
             * The original string may remain in memory until garbage collected, but this
             * reduces the window of vulnerability by breaking the reference.
             * @param {string} str - The string to wipe
             * @returns {string} A zeroed-out string of the same length
             */
            function wipeString(str) {
                if (typeof str === 'string' && str.length > 0) {
                    return '\0'.repeat(str.length);
                }
                return '';
            }

            // ==========================================================================
            // CORE GALOIS FIELD (GF(2053)) ARITHMETIC
            // ==========================================================================
            /**
             * Reduces an integer into GF(2053) by applying modulo with wraparound for negatives.
             */
            function mod(value) {
                const result = value % FIELD_PRIME;
                return result < 0 ? result + FIELD_PRIME : result;
            }

            /**
             * Adds two field elements and returns the result modulo 2053.
             */
            function modAdd(a, b) {
                return mod(a + b);
            }

            /**
             * Subtracts the second field element from the first inside GF(2053).
             */
            function modSub(a, b) {
                return mod(a - b);
            }

            /**
             * Multiplies two field elements and reduces the product into GF(2053).
             */
            function modMul(a, b) {
                return mod(a * b);
            }

            /**
             * Computes the multiplicative inverse of a non-zero field element.
             */
            function modInv(value) {
                const val = mod(value);
                if (val === 0) {
                    throw new Error('Attempted to invert zero in GF(2053).');
                }
                let t = 0;
                let newT = 1;
                let r = FIELD_PRIME;
                let newR = val;
                while (newR !== 0) {
                    const quotient = Math.floor(r / newR);
                    [t, newT] = [newT, t - quotient * newT];
                    [r, newR] = [newR, r - quotient * newR];
                }
                if (r > 1) {
                    throw new Error('Value is not invertible in GF(2053).');
                }
                if (t < 0) {
                    t += FIELD_PRIME;
                }
                return t;
            }

            // ==========================================================================
            // CRYPTOGRAPHICALLY SECURE RANDOMNESS
            // ==========================================================================
            /**
             * Returns a uniform random integer in [0, max] using window.crypto entropy.
             */
            function getRandomIntInclusive(max) {
                if (!randomSource || typeof randomSource.getRandomValues !== 'function') {
                    const fallback = GLOBAL_SCOPE.crypto;
                    if (fallback && typeof fallback.getRandomValues === 'function') {
                        randomSource = fallback;
                    } else {
                        throw new Error('Secure randomness provider is not configured.');
                    }
                }
                const range = max + 1;
                if (range <= 0) {
                    throw new Error('Invalid range for randomness.');
                }
                const maxUint32 = 0x100000000;
                const limit = maxUint32 - (maxUint32 % range);
                const buffer = new Uint32Array(1);
                let value;
                do {
                    randomSource.getRandomValues(buffer);
                    value = buffer[0];
                } while (value >= limit);
                return value % range;
            }

            /**
             * Draws a random element from GF(2053).
             */
            function getRandomFieldElement() {
                return getRandomIntInclusive(FIELD_PRIME - 1);
            }
            
            // ==========================================================================
            // POLYNOMIAL & INTERPOLATION LOGIC
            // ==========================================================================
            /**
             * Builds a random polynomial of the requested degree whose constant term is the secret.
             */
            function randomPolynomial(secret, degree) {
                const coefficients = [mod(secret)];
                for (let i = 0; i < degree; i++) {
                    coefficients.push(getRandomFieldElement());
                }
                return coefficients;
            }

            /**
             * Evaluates a polynomial at the provided x coordinate inside GF(2053).
             */
            function evaluatePolynomial(coefficients, x) {
                let result = 0;
                const fieldX = mod(x);
                for (let i = coefficients.length - 1; i >= 0; i--) {
                    result = modAdd(modMul(result, fieldX), coefficients[i]);
                }
                return result;
            }

            /**
             * Applies Lagrange interpolation at x=0 to recover the secret from share points.
             */
            function lagrangeInterpolateAtZero(points) {
                if (!Array.isArray(points) || points.length === 0) {
                    throw new Error('Interpolation requires at least one point.');
                }
                let sum = 0;
                for (let j = 0; j < points.length; j++) {
                    let numerator = 1;
                    let denominator = 1;
                    const xj = mod(points[j].x);
                    const yj = mod(points[j].y);
                    for (let m = 0; m < points.length; m++) {
                        if (m === j) continue;
                        const xm = mod(points[m].x);
                        numerator = modMul(numerator, mod(FIELD_PRIME - xm));
                        denominator = modMul(denominator, modSub(xj, xm));
                    }
                    const term = modMul(yj, modMul(numerator, modInv(denominator)));
                    sum = modAdd(sum, term);
                }
                return sum;
            }

            /**
             * Computes the Lagrange multipliers (Œª) for the provided share numbers at X=0.
             */
            function computeLagrangeMultipliers(shareNumbers) {
                if (!Array.isArray(shareNumbers) || shareNumbers.length < 2) {
                    throw new Error('At least two share numbers are required to compute multipliers.');
                }
                const normalized = shareNumbers.map((value, index) => normalizeShareValue(value, `Share number ${index + 1}`));
                const seen = new Set();
                normalized.forEach((value) => {
                    if (value === 0) {
                        throw new Error('Share numbers cannot be zero.');
                    }
                    if (seen.has(value)) {
                        throw new Error('Share numbers must be unique.');
                    }
                    seen.add(value);
                });
                const multipliers = [];
                for (let i = 0; i < normalized.length; i++) {
                    let numerator = 1;
                    let denominator = 1;
                    const xi = mod(normalized[i]);
                    for (let j = 0; j < normalized.length; j++) {
                        if (i === j) continue;
                        const xj = mod(normalized[j]);
                        numerator = modMul(numerator, mod(FIELD_PRIME - xj));
                        denominator = modMul(denominator, modSub(xi, xj));
                    }
                    multipliers.push(modMul(numerator, modInv(denominator)));
                }
                return multipliers;
            }

            // ==========================================================================
            // CHECKSUM & VALIDATION HELPERS
            // ==========================================================================
            /**
             * Computes the per-row checksum (sum of three words) for all word indices.
             */
            function computeRowChecks(wordIndices) {
                const rowCount = wordIndices.length / WORDS_PER_ROW;
                const checks = [];
                for (let row = 0; row < rowCount; row++) {
                    const base = row * WORDS_PER_ROW;
                    const sum = modAdd(modAdd(wordIndices[base], wordIndices[base + 1]), wordIndices[base + 2]);
                    checks.push(sum);
                }
                return checks;
            }
            
            /**
             * Calculates the global checksum by summing all word indices mod 2053.
             */
            function computeGlobalChecksum(wordIndices) {
                return wordIndices.reduce((acc, value) => modAdd(acc, value), 0);
            }
            
            /**
             * Normalizes whitespace/case on a mnemonic and ensures it is non-empty.
             */
            function sanitizeMnemonic(mnemonic) {
                if (typeof mnemonic !== 'string') {
                    throw new Error('Mnemonic must be a string.');
                }
                const normalized = mnemonic.trim().toLowerCase().replace(/\s+/g, ' ');
                if (!normalized) {
                    throw new Error('Mnemonic cannot be empty.');
                }
                return normalized;
            }

            /**
             * Ensures the mnemonic word count is one of the supported lengths.
             */
            function ensureSupportedWordCount(wordCount) {
                if (wordCount !== 12 && wordCount !== 24) {
                    throw new Error('This tool currently supports only 12- or 24-word mnemonics.');
                }
            }

            /**
             * Validates that a share value is an integer inside GF(2053) and returns it.
             */
            function normalizeShareValue(value, label) {
                if (!Number.isInteger(value)) {
                    throw new Error(`${label} must be an integer inside GF(2053).`);
                }
                if (value < 0 || value >= FIELD_PRIME) {
                    throw new Error(`${label} must be between 0 and ${FIELD_PRIME - 1}.`);
                }
                return value;
            }

            /**
             * Performs structural validation on each share before attempting recovery.
             */
            function validateSharesForRecovery(shares, wordCount) {
                const rowCount = wordCount / WORDS_PER_ROW;
                shares.forEach((share, index) => {
                    if (!Number.isInteger(share.shareNumber) || share.shareNumber <= 0 || share.shareNumber >= FIELD_PRIME) {
                        throw new Error(`Share #${index + 1} is missing a valid share number (1-${FIELD_PRIME - 1}).`);
                    }
                    if (!Array.isArray(share.wordShares) || share.wordShares.length !== wordCount) {
                        throw new Error(`Share #${share.shareNumber} does not contain ${wordCount} word values.`);
                    }
                    if (!Array.isArray(share.checksumShares) || share.checksumShares.length !== rowCount) {
                        throw new Error(`Share #${share.shareNumber} does not contain ${rowCount} checksum values.`);
                    }
                    if (!Number.isInteger(share.globalChecksumVerificationShare)) {
                        throw new Error(`Share #${share.shareNumber} is missing a global checksum.`);
                    }
                });
            }

            /**
             * Ensures that every share provided has a unique X coordinate.
             */
            function ensureShareNumbersDistinct(shares) {
                const seen = new Set();
                for (const share of shares) {
                    if (seen.has(share.shareNumber)) {
                        throw new Error('Duplicate share numbers detected.');
                    }
                    seen.add(share.shareNumber);
                }
            }
            
            // ==========================================================================
            // BIP39 CHECKSUM VALIDATION
            // ==========================================================================
            /**
             * Converts a Uint8Array into a continuous string of bits.
             */
            function bytesToBinary(bytes) {
                return Array.from(bytes).map((b) => b.toString(2).padStart(8, '0')).join('');
            }

            /**
             * Hashes the provided data using the embedded SHA-256 implementation.
             */
            async function computeSha256(data) {
                if (!sha256Impl || typeof sha256Impl.arrayBuffer !== 'function') {
                    const fallback = GLOBAL_SCOPE.sha256;
                    if (typeof fallback === 'function' && typeof fallback.arrayBuffer === 'function') {
                        sha256Impl = fallback;
                    } else {
                        throw new Error('SHA-256 implementation is not configured.');
                    }
                }
                return new Uint8Array(sha256Impl.arrayBuffer(data));
            }

            /**
             * Validates that a mnemonic string is BIP39-compliant, including checksum.
             */
            async function validateBIP39Mnemonic(mnemonic, wordlist) {
                const words = mnemonic.trim().split(/\s+/);
                const wordCount = words.length;
                if (wordCount % 3 !== 0 || wordCount < 12 || wordCount > 24) {
                    throw new Error(`Invalid mnemonic length: expected 12, 15, 18, 21, or 24 words, received ${wordCount}.`);
                }
                let binaryMnemonic = '';
                for (const word of words) {
                    const index = wordlist.indexOf(word);
                    if (index === -1) {
                        throw new Error(`Invalid mnemonic word: "${word}" is not in the BIP39 list.`);
                    }
                    binaryMnemonic += index.toString(2).padStart(11, '0');
                }
                const entropyBits = (wordCount * 11) - (wordCount / 3);
                const checksumLength = wordCount / 3;
                const entropyBinary = binaryMnemonic.substring(0, entropyBits);
                const checksumBinary = binaryMnemonic.substring(entropyBits);
                const entropyBytes = new Uint8Array(entropyBits / 8);
                for (let i = 0; i < (entropyBits / 8); i++) {
                    const byteString = entropyBinary.substr(i * 8, 8);
                    entropyBytes[i] = parseInt(byteString, 2);
                }
                const hashBytes = await computeSha256(entropyBytes);
                const hashBinary = bytesToBinary(hashBytes);
                const derivedChecksum = hashBinary.substring(0, checksumLength);
                // Use constant-time comparison to prevent timing attacks
                if (!constantTimeStringEqual(derivedChecksum, checksumBinary)) {
                    throw new Error('Mnemonic checksum is invalid.');
                }
                return true;
            }
            
            // ==========================================================================
            // PUBLIC API METHODS
            // ==========================================================================
            /**
             * Splits a BIP39 mnemonic into n Shamir shares with threshold k.
             */
            async function splitBip39(mnemonic, k, n, wordlist) {
                if (!Number.isInteger(k) || !Number.isInteger(n)) {
                    throw new Error('Threshold (k) and total shares (n) must be integers.');
                }
                if (k < 2) {
                    throw new Error('Threshold k must be at least 2.');
                }
                if (k > n) {
                    throw new Error('Threshold k cannot exceed n.');
                }
                if (n >= FIELD_PRIME) {
                    throw new Error('Total shares (n) must be less than 2053.');
                }
                const normalizedMnemonic = sanitizeMnemonic(mnemonic);
                await validateBIP39Mnemonic(normalizedMnemonic, wordlist);
                const words = normalizedMnemonic.split(' ');
                const wordCount = words.length;
                ensureSupportedWordCount(wordCount);
                const wordIndices = words.map((word) => {
                    const index = wordlist.indexOf(word);
                    if (index === -1) {
                        throw new Error(`Unknown mnemonic word: "${word}".`);
                    }
                    return index;
                });
                const checksumSecrets = computeRowChecks(wordIndices);
                const globalChecksumSecret = wordIndices.reduce((acc, value) => modAdd(acc, value), 0);
                const degree = k - 1;

                const wordPolynomials = wordIndices.map((secret) => randomPolynomial(secret, degree));
                const checksumPolynomials = checksumSecrets.map((secret) => randomPolynomial(secret, degree));
                const globalChecksumPolynomial = randomPolynomial(globalChecksumSecret, degree);
                
                const shares = [];
                try {
                    for (let shareIndex = 1; shareIndex <= n; shareIndex++) {
                        const share = {
                            shareNumber: shareIndex,
                            wordShares: [],
                            checksumShares: [],
                            globalChecksumVerificationShare: 0
                        };
                        for (const polynomial of wordPolynomials) {
                            share.wordShares.push(evaluatePolynomial(polynomial, shareIndex));
                        }
                        for (const polynomial of checksumPolynomials) {
                            share.checksumShares.push(evaluatePolynomial(polynomial, shareIndex));
                        }
                        share.globalChecksumVerificationShare = evaluatePolynomial(globalChecksumPolynomial, shareIndex);
                        shares.push(share);
                    }
                    return { shares };
                } finally {
                    // Security: Clean up sensitive data from memory
                    secureWipeArray(wordIndices);
                    secureWipeArray(checksumSecrets);
                    wordPolynomials.forEach(poly => secureWipeArray(poly));
                    checksumPolynomials.forEach(poly => secureWipeArray(poly));
                    secureWipeArray(globalChecksumPolynomial);
                }
            }

            /**
             * Performs a unified recovery and validation pipeline. This function does not throw on
             * validation failures; instead, it returns a detailed report object containing the
             * recovered mnemonic (if successful) and a breakdown of any errors encountered.
             * @param {Array<Object>} shares - An array of share objects from the UI.
             * @param {number} wordCount - The expected word count of the original mnemonic (12 or 24).
             * @param {Array<string>} wordlist - The BIP39 wordlist.
             * @returns {Promise<Object>} A report object with detailed error tracking
             */
            async function recoverAndValidate(shares, wordCount, wordlist) {
                const report = {
                    recoveredMnemonic: null,
                    recoveredIndices: null,
                    errors: {
                        failedRows: [],  // Array of {rowNumber, wordPositions, checksumLabel}
                        globalChecksumError: {
                            failed: false,
                            isNightmare: false
                        },
                        bip39: false,
                        generic: null
                    }
                };

                // Declare sensitive variables outside try block for cleanup in finally
                let recoveredWords = [];
                let recoveredChecks = [];
                let recoveredGlobalChecksum = 0;

                try {
                    // 1. Pre-flight checks for input validity
                    if (!Array.isArray(shares) || shares.length < 2) {
                        report.errors.generic = 'At least two shares are required for recovery.';
                        return report;
                    }
                    ensureSupportedWordCount(wordCount);
                    if (wordCount % WORDS_PER_ROW !== 0) {
                        report.errors.generic = 'Word count must be divisible by the words per row constant.';
                        return report;
                    }
                    validateSharesForRecovery(shares, wordCount);
                    ensureShareNumbersDistinct(shares);

                    const rowCount = wordCount / WORDS_PER_ROW;

                    // 2. Recover all secret numbers via Lagrange Interpolation
                    recoveredWords = [];
                    for (let i = 0; i < wordCount; i++) {
                        const points = shares.map((share) => ({
                            x: mod(share.shareNumber),
                            y: normalizeShareValue(share.wordShares[i], `Word share #${i + 1} (share ${share.shareNumber})`)
                        }));
                        recoveredWords.push(lagrangeInterpolateAtZero(points));
                    }

                    recoveredChecks = [];
                    for (let row = 0; row < rowCount; row++) {
                        const points = shares.map((share) => ({
                            x: mod(share.shareNumber),
                            y: normalizeShareValue(share.checksumShares[row], `Checksum share C${row + 1} (share ${share.shareNumber})`)
                        }));
                        recoveredChecks.push(lagrangeInterpolateAtZero(points));
                    }
                    
                    const globalChecksumPoints = shares.map((share) => ({
                        x: mod(share.shareNumber),
                        y: normalizeShareValue(share.globalChecksumVerificationShare, `Global Checksum verification (share ${share.shareNumber})`)
                    }));
                    recoveredGlobalChecksum = lagrangeInterpolateAtZero(globalChecksumPoints);
                    
                    // 3. Perform internal Schiavinato validations (COLLECT ALL ERRORS - don't stop early)
                    const recomputedChecks = computeRowChecks(recoveredWords);
                    for (let rowIdx = 0; rowIdx < rowCount; rowIdx++) {
                        // Use constant-time comparison to prevent timing attacks
                        if (!constantTimeEqual(recoveredChecks[rowIdx], recomputedChecks[rowIdx])) {
                            // Convert to 1-indexed for human display
                            const rowNumber = rowIdx + 1;
                            const wordPositions = [
                                rowIdx * WORDS_PER_ROW + 1,
                                rowIdx * WORDS_PER_ROW + 2,
                                rowIdx * WORDS_PER_ROW + 3
                            ];
                            report.errors.failedRows.push({
                                rowNumber: rowNumber,
                                wordPositions: wordPositions,
                                checksumLabel: `C${rowNumber}`
                            });
                        }
                    }

                    const recomputedGlobalChecksum = computeGlobalChecksum(recoveredWords);
                    // Use constant-time comparison to prevent timing attacks
                    if (!constantTimeEqual(recoveredGlobalChecksum, recomputedGlobalChecksum)) {
                        report.errors.globalChecksumError.failed = true;
                        // Nightmare scenario: all rows pass but global checksum fails
                        report.errors.globalChecksumError.isNightmare = (report.errors.failedRows.length === 0);
                    }

                    // 4. ALWAYS build the mnemonic (even if checksums failed)
                    // Check if indices are in BIP39 range
                    let canFormMnemonic = true;
                    for(let i = 0; i < recoveredWords.length; i++) {
                        const value = recoveredWords[i];
                        if (value < 0 || value >= 2048) {
                            report.errors.generic = `Recovered word #${i + 1} ("${value}") is outside the BIP39 range (0‚Äì2047). Cannot form a valid mnemonic.`;
                            canFormMnemonic = false;
                            break;
                        }
                    }
                    
                    if (canFormMnemonic) {
                        const mnemonic = recoveredWords.map((index) => wordlist[index]).join(' ');
                        report.recoveredMnemonic = mnemonic;
                        report.recoveredIndices = [...recoveredWords];  // Store copy

                        // 5. Validate BIP39 ONLY if all Schiavinato checks passed
                        if (report.errors.failedRows.length === 0 && !report.errors.globalChecksumError.failed) {
                            try {
                                await validateBIP39Mnemonic(mnemonic, wordlist);
                            } catch (bip39Error) {
                                report.errors.bip39 = true;
                                // Keep the mnemonic even if BIP39 fails - user might need it for brute-forcing
                            }
                        }
                    }

                } catch (error) {
                    // Catch unrecoverable errors (e.g., bad inputs, non-invertible matrix)
                    report.errors.generic = error.message;
                } finally {
                    // Security: Clean up sensitive data from memory
                    secureWipeArray(recoveredWords);
                    secureWipeArray(recoveredChecks);
                    recoveredGlobalChecksum = 0;
                }

                return report;
            }
            
            // Expose public methods
            return {
                splitBip39,
                recoverAndValidate,
                validateBIP39Mnemonic,
                computeRowChecks,
                computeGlobalChecksum,
                configureEnvironment,
                getRandomFieldElement, // Expose for the manual helper tool
                computeLagrangeMultipliers,
                wipeString, // Expose for UI-side cleanup of sensitive strings
                secureWipeArray // Expose for UI-side cleanup of sensitive arrays
            };
        })();

        // BIP39 English wordlist (2048 words)
        const BIP39_WORDLIST = [
            "abandon",
            "ability",
            "able",
            "about",
            "above",
            "absent",
            "absorb",
            "abstract",
            "absurd",
            "abuse",
            "access",
            "accident",
            "account",
            "accuse",
            "achieve",
            "acid",
            "acoustic",
            "acquire",
            "across",
            "act",
            "action",
            "actor",
            "actress",
            "actual",
            "adapt",
            "add",
            "addict",
            "address",
            "adjust",
            "admit",
            "adult",
            "advance",
            "advice",
            "aerobic",
            "affair",
            "afford",
            "afraid",
            "again",
            "age",
            "agent",
            "agree",
            "ahead",
            "aim",
            "air",
            "airport",
            "aisle",
            "alarm",
            "album",
            "alcohol",
            "alert",
            "alien",
            "all",
            "alley",
            "allow",
            "almost",
            "alone",
            "alpha",
            "already",
            "also",
            "alter",
            "always",
            "amateur",
            "amazing",
            "among",
            "amount",
            "amused",
            "analyst",
            "anchor",
            "ancient",
            "anger",
            "angle",
            "angry",
            "animal",
            "ankle",
            "announce",
            "annual",
            "another",
            "answer",
            "antenna",
            "antique",
            "anxiety",
            "any",
            "apart",
            "apology",
            "appear",
            "apple",
            "approve",
            "april",
            "arch",
            "arctic",
            "area",
            "arena",
            "argue",
            "arm",
            "armed",
            "armor",
            "army",
            "around",
            "arrange",
            "arrest",
            "arrive",
            "arrow",
            "art",
            "artefact",
            "artist",
            "artwork",
            "ask",
            "aspect",
            "assault",
            "asset",
            "assist",
            "assume",
            "asthma",
            "athlete",
            "atom",
            "attack",
            "attend",
            "attitude",
            "attract",
            "auction",
            "audit",
            "august",
            "aunt",
            "author",
            "auto",
            "autumn",
            "average",
            "avocado",
            "avoid",
            "awake",
            "aware",
            "away",
            "awesome",
            "awful",
            "awkward",
            "axis",
            "baby",
            "bachelor",
            "bacon",
            "badge",
            "bag",
            "balance",
            "balcony",
            "ball",
            "bamboo",
            "banana",
            "banner",
            "bar",
            "barely",
            "bargain",
            "barrel",
            "base",
            "basic",
            "basket",
            "battle",
            "beach",
            "bean",
            "beauty",
            "because",
            "become",
            "beef",
            "before",
            "begin",
            "behave",
            "behind",
            "believe",
            "below",
            "belt",
            "bench",
            "benefit",
            "best",
            "betray",
            "better",
            "between",
            "beyond",
            "bicycle",
            "bid",
            "bike",
            "bind",
            "biology",
            "bird",
            "birth",
            "bitter",
            "black",
            "blade",
            "blame",
            "blanket",
            "blast",
            "bleak",
            "bless",
            "blind",
            "blood",
            "blossom",
            "blouse",
            "blue",
            "blur",
            "blush",
            "board",
            "boat",
            "body",
            "boil",
            "bomb",
            "bone",
            "bonus",
            "book",
            "boost",
            "border",
            "boring",
            "borrow",
            "boss",
            "bottom",
            "bounce",
            "box",
            "boy",
            "bracket",
            "brain",
            "brand",
            "brass",
            "brave",
            "bread",
            "breeze",
            "brick",
            "bridge",
            "brief",
            "bright",
            "bring",
            "brisk",
            "broccoli",
            "broken",
            "bronze",
            "broom",
            "brother",
            "brown",
            "brush",
            "bubble",
            "buddy",
            "budget",
            "buffalo",
            "build",
            "bulb",
            "bulk",
            "bullet",
            "bundle",
            "bunker",
            "burden",
            "burger",
            "burst",
            "bus",
            "business",
            "busy",
            "butter",
            "buyer",
            "buzz",
            "cabbage",
            "cabin",
            "cable",
            "cactus",
            "cage",
            "cake",
            "call",
            "calm",
            "camera",
            "camp",
            "can",
            "canal",
            "cancel",
            "candy",
            "cannon",
            "canoe",
            "canvas",
            "canyon",
            "capable",
            "capital",
            "captain",
            "car",
            "carbon",
            "card",
            "cargo",
            "carpet",
            "carry",
            "cart",
            "case",
            "cash",
            "casino",
            "castle",
            "casual",
            "cat",
            "catalog",
            "catch",
            "category",
            "cattle",
            "caught",
            "cause",
            "caution",
            "cave",
            "ceiling",
            "celery",
            "cement",
            "census",
            "century",
            "cereal",
            "certain",
            "chair",
            "chalk",
            "champion",
            "change",
            "chaos",
            "chapter",
            "charge",
            "chase",
            "chat",
            "cheap",
            "check",
            "cheese",
            "chef",
            "cherry",
            "chest",
            "chicken",
            "chief",
            "child",
            "chimney",
            "choice",
            "choose",
            "chronic",
            "chuckle",
            "chunk",
            "churn",
            "cigar",
            "cinnamon",
            "circle",
            "citizen",
            "city",
            "civil",
            "claim",
            "clap",
            "clarify",
            "claw",
            "clay",
            "clean",
            "clerk",
            "clever",
            "click",
            "client",
            "cliff",
            "climb",
            "clinic",
            "clip",
            "clock",
            "clog",
            "close",
            "cloth",
            "cloud",
            "clown",
            "club",
            "clump",
            "cluster",
            "clutch",
            "coach",
            "coast",
            "coconut",
            "code",
            "coffee",
            "coil",
            "coin",
            "collect",
            "color",
            "column",
            "combine",
            "come",
            "comfort",
            "comic",
            "common",
            "company",
            "concert",
            "conduct",
            "confirm",
            "congress",
            "connect",
            "consider",
            "control",
            "convince",
            "cook",
            "cool",
            "copper",
            "copy",
            "coral",
            "core",
            "corn",
            "correct",
            "cost",
            "cotton",
            "couch",
            "country",
            "couple",
            "course",
            "cousin",
            "cover",
            "coyote",
            "crack",
            "cradle",
            "craft",
            "cram",
            "crane",
            "crash",
            "crater",
            "crawl",
            "crazy",
            "cream",
            "credit",
            "creek",
            "crew",
            "cricket",
            "crime",
            "crisp",
            "critic",
            "crop",
            "cross",
            "crouch",
            "crowd",
            "crucial",
            "cruel",
            "cruise",
            "crumble",
            "crunch",
            "crush",
            "cry",
            "crystal",
            "cube",
            "culture",
            "cup",
            "cupboard",
            "curious",
            "current",
            "curtain",
            "curve",
            "cushion",
            "custom",
            "cute",
            "cycle",
            "dad",
            "damage",
            "damp",
            "dance",
            "danger",
            "daring",
            "dash",
            "daughter",
            "dawn",
            "day",
            "deal",
            "debate",
            "debris",
            "decade",
            "december",
            "decide",
            "decline",
            "decorate",
            "decrease",
            "deer",
            "defense",
            "define",
            "defy",
            "degree",
            "delay",
            "deliver",
            "demand",
            "demise",
            "denial",
            "dentist",
            "deny",
            "depart",
            "depend",
            "deposit",
            "depth",
            "deputy",
            "derive",
            "describe",
            "desert",
            "design",
            "desk",
            "despair",
            "destroy",
            "detail",
            "detect",
            "develop",
            "device",
            "devote",
            "diagram",
            "dial",
            "diamond",
            "diary",
            "dice",
            "diesel",
            "diet",
            "differ",
            "digital",
            "dignity",
            "dilemma",
            "dinner",
            "dinosaur",
            "direct",
            "dirt",
            "disagree",
            "discover",
            "disease",
            "dish",
            "dismiss",
            "disorder",
            "display",
            "distance",
            "divert",
            "divide",
            "divorce",
            "dizzy",
            "doctor",
            "document",
            "dog",
            "doll",
            "dolphin",
            "domain",
            "donate",
            "donkey",
            "donor",
            "door",
            "dose",
            "double",
            "dove",
            "draft",
            "dragon",
            "drama",
            "drastic",
            "draw",
            "dream",
            "dress",
            "drift",
            "drill",
            "drink",
            "drip",
            "drive",
            "drop",
            "drum",
            "dry",
            "duck",
            "dumb",
            "dune",
            "during",
            "dust",
            "dutch",
            "duty",
            "dwarf",
            "dynamic",
            "eager",
            "eagle",
            "early",
            "earn",
            "earth",
            "easily",
            "east",
            "easy",
            "echo",
            "ecology",
            "economy",
            "edge",
            "edit",
            "educate",
            "effort",
            "egg",
            "eight",
            "either",
            "elbow",
            "elder",
            "electric",
            "elegant",
            "element",
            "elephant",
            "elevator",
            "elite",
            "else",
            "embark",
            "embody",
            "embrace",
            "emerge",
            "emotion",
            "employ",
            "empower",
            "empty",
            "enable",
            "enact",
            "end",
            "endless",
            "endorse",
            "enemy",
            "energy",
            "enforce",
            "engage",
            "engine",
            "enhance",
            "enjoy",
            "enlist",
            "enough",
            "enrich",
            "enroll",
            "ensure",
            "enter",
            "entire",
            "entry",
            "envelope",
            "episode",
            "equal",
            "equip",
            "era",
            "erase",
            "erode",
            "erosion",
            "error",
            "erupt",
            "escape",
            "essay",
            "essence",
            "estate",
            "eternal",
            "ethics",
            "evidence",
            "evil",
            "evoke",
            "evolve",
            "exact",
            "example",
            "excess",
            "exchange",
            "excite",
            "exclude",
            "excuse",
            "execute",
            "exercise",
            "exhaust",
            "exhibit",
            "exile",
            "exist",
            "exit",
            "exotic",
            "expand",
            "expect",
            "expire",
            "explain",
            "expose",
            "express",
            "extend",
            "extra",
            "eye",
            "eyebrow",
            "fabric",
            "face",
            "faculty",
            "fade",
            "faint",
            "faith",
            "fall",
            "false",
            "fame",
            "family",
            "famous",
            "fan",
            "fancy",
            "fantasy",
            "farm",
            "fashion",
            "fat",
            "fatal",
            "father",
            "fatigue",
            "fault",
            "favorite",
            "feature",
            "february",
            "federal",
            "fee",
            "feed",
            "feel",
            "female",
            "fence",
            "festival",
            "fetch",
            "fever",
            "few",
            "fiber",
            "fiction",
            "field",
            "figure",
            "file",
            "film",
            "filter",
            "final",
            "find",
            "fine",
            "finger",
            "finish",
            "fire",
            "firm",
            "first",
            "fiscal",
            "fish",
            "fit",
            "fitness",
            "fix",
            "flag",
            "flame",
            "flash",
            "flat",
            "flavor",
            "flee",
            "flight",
            "flip",
            "float",
            "flock",
            "floor",
            "flower",
            "fluid",
            "flush",
            "fly",
            "foam",
            "focus",
            "fog",
            "foil",
            "fold",
            "follow",
            "food",
            "foot",
            "force",
            "forest",
            "forget",
            "fork",
            "fortune",
            "forum",
            "forward",
            "fossil",
            "foster",
            "found",
            "fox",
            "fragile",
            "frame",
            "frequent",
            "fresh",
            "friend",
            "fringe",
            "frog",
            "front",
            "frost",
            "frown",
            "frozen",
            "fruit",
            "fuel",
            "fun",
            "funny",
            "furnace",
            "fury",
            "future",
            "gadget",
            "gain",
            "galaxy",
            "gallery",
            "game",
            "gap",
            "garage",
            "garbage",
            "garden",
            "garlic",
            "garment",
            "gas",
            "gasp",
            "gate",
            "gather",
            "gauge",
            "gaze",
            "general",
            "genius",
            "genre",
            "gentle",
            "genuine",
            "gesture",
            "ghost",
            "giant",
            "gift",
            "giggle",
            "ginger",
            "giraffe",
            "girl",
            "give",
            "glad",
            "glance",
            "glare",
            "glass",
            "glide",
            "glimpse",
            "globe",
            "gloom",
            "glory",
            "glove",
            "glow",
            "glue",
            "goat",
            "goddess",
            "gold",
            "good",
            "goose",
            "gorilla",
            "gospel",
            "gossip",
            "govern",
            "gown",
            "grab",
            "grace",
            "grain",
            "grant",
            "grape",
            "grass",
            "gravity",
            "great",
            "green",
            "grid",
            "grief",
            "grit",
            "grocery",
            "group",
            "grow",
            "grunt",
            "guard",
            "guess",
            "guide",
            "guilt",
            "guitar",
            "gun",
            "gym",
            "habit",
            "hair",
            "half",
            "hammer",
            "hamster",
            "hand",
            "happy",
            "harbor",
            "hard",
            "harsh",
            "harvest",
            "hat",
            "have",
            "hawk",
            "hazard",
            "head",
            "health",
            "heart",
            "heavy",
            "hedgehog",
            "height",
            "hello",
            "helmet",
            "help",
            "hen",
            "hero",
            "hidden",
            "high",
            "hill",
            "hint",
            "hip",
            "hire",
            "history",
            "hobby",
            "hockey",
            "hold",
            "hole",
            "holiday",
            "hollow",
            "home",
            "honey",
            "hood",
            "hope",
            "horn",
            "horror",
            "horse",
            "hospital",
            "host",
            "hotel",
            "hour",
            "hover",
            "hub",
            "huge",
            "human",
            "humble",
            "humor",
            "hundred",
            "hungry",
            "hunt",
            "hurdle",
            "hurry",
            "hurt",
            "husband",
            "hybrid",
            "ice",
            "icon",
            "idea",
            "identify",
            "idle",
            "ignore",
            "ill",
            "illegal",
            "illness",
            "image",
            "imitate",
            "immense",
            "immune",
            "impact",
            "impose",
            "improve",
            "impulse",
            "inch",
            "include",
            "income",
            "increase",
            "index",
            "indicate",
            "indoor",
            "industry",
            "infant",
            "inflict",
            "inform",
            "inhale",
            "inherit",
            "initial",
            "inject",
            "injury",
            "inmate",
            "inner",
            "innocent",
            "input",
            "inquiry",
            "insane",
            "insect",
            "inside",
            "inspire",
            "install",
            "intact",
            "interest",
            "into",
            "invest",
            "invite",
            "involve",
            "iron",
            "island",
            "isolate",
            "issue",
            "item",
            "ivory",
            "jacket",
            "jaguar",
            "jar",
            "jazz",
            "jealous",
            "jeans",
            "jelly",
            "jewel",
            "job",
            "join",
            "joke",
            "journey",
            "joy",
            "judge",
            "juice",
            "jump",
            "jungle",
            "junior",
            "junk",
            "just",
            "kangaroo",
            "keen",
            "keep",
            "ketchup",
            "key",
            "kick",
            "kid",
            "kidney",
            "kind",
            "kingdom",
            "kiss",
            "kit",
            "kitchen",
            "kite",
            "kitten",
            "kiwi",
            "knee",
            "knife",
            "knock",
            "know",
            "lab",
            "label",
            "labor",
            "ladder",
            "lady",
            "lake",
            "lamp",
            "language",
            "laptop",
            "large",
            "later",
            "latin",
            "laugh",
            "laundry",
            "lava",
            "law",
            "lawn",
            "lawsuit",
            "layer",
            "lazy",
            "leader",
            "leaf",
            "learn",
            "leave",
            "lecture",
            "left",
            "leg",
            "legal",
            "legend",
            "leisure",
            "lemon",
            "lend",
            "length",
            "lens",
            "leopard",
            "lesson",
            "letter",
            "level",
            "liar",
            "liberty",
            "library",
            "license",
            "life",
            "lift",
            "light",
            "like",
            "limb",
            "limit",
            "link",
            "lion",
            "liquid",
            "list",
            "little",
            "live",
            "lizard",
            "load",
            "loan",
            "lobster",
            "local",
            "lock",
            "logic",
            "lonely",
            "long",
            "loop",
            "lottery",
            "loud",
            "lounge",
            "love",
            "loyal",
            "lucky",
            "luggage",
            "lumber",
            "lunar",
            "lunch",
            "luxury",
            "lyrics",
            "machine",
            "mad",
            "magic",
            "magnet",
            "maid",
            "mail",
            "main",
            "major",
            "make",
            "mammal",
            "man",
            "manage",
            "mandate",
            "mango",
            "mansion",
            "manual",
            "maple",
            "marble",
            "march",
            "margin",
            "marine",
            "market",
            "marriage",
            "mask",
            "mass",
            "master",
            "match",
            "material",
            "math",
            "matrix",
            "matter",
            "maximum",
            "maze",
            "meadow",
            "mean",
            "measure",
            "meat",
            "mechanic",
            "medal",
            "media",
            "melody",
            "melt",
            "member",
            "memory",
            "mention",
            "menu",
            "mercy",
            "merge",
            "merit",
            "merry",
            "mesh",
            "message",
            "metal",
            "method",
            "middle",
            "midnight",
            "milk",
            "million",
            "mimic",
            "mind",
            "minimum",
            "minor",
            "minute",
            "miracle",
            "mirror",
            "misery",
            "miss",
            "mistake",
            "mix",
            "mixed",
            "mixture",
            "mobile",
            "model",
            "modify",
            "mom",
            "moment",
            "monitor",
            "monkey",
            "monster",
            "month",
            "moon",
            "moral",
            "more",
            "morning",
            "mosquito",
            "mother",
            "motion",
            "motor",
            "mountain",
            "mouse",
            "move",
            "movie",
            "much",
            "muffin",
            "mule",
            "multiply",
            "muscle",
            "museum",
            "mushroom",
            "music",
            "must",
            "mutual",
            "myself",
            "mystery",
            "myth",
            "naive",
            "name",
            "napkin",
            "narrow",
            "nasty",
            "nation",
            "nature",
            "near",
            "neck",
            "need",
            "negative",
            "neglect",
            "neither",
            "nephew",
            "nerve",
            "nest",
            "net",
            "network",
            "neutral",
            "never",
            "news",
            "next",
            "nice",
            "night",
            "noble",
            "noise",
            "nominee",
            "noodle",
            "normal",
            "north",
            "nose",
            "notable",
            "note",
            "nothing",
            "notice",
            "novel",
            "now",
            "nuclear",
            "number",
            "nurse",
            "nut",
            "oak",
            "obey",
            "object",
            "oblige",
            "obscure",
            "observe",
            "obtain",
            "obvious",
            "occur",
            "ocean",
            "october",
            "odor",
            "off",
            "offer",
            "office",
            "often",
            "oil",
            "okay",
            "old",
            "olive",
            "olympic",
            "omit",
            "once",
            "one",
            "onion",
            "online",
            "only",
            "open",
            "opera",
            "opinion",
            "oppose",
            "option",
            "orange",
            "orbit",
            "orchard",
            "order",
            "ordinary",
            "organ",
            "orient",
            "original",
            "orphan",
            "ostrich",
            "other",
            "outdoor",
            "outer",
            "output",
            "outside",
            "oval",
            "oven",
            "over",
            "own",
            "owner",
            "oxygen",
            "oyster",
            "ozone",
            "pact",
            "paddle",
            "page",
            "pair",
            "palace",
            "palm",
            "panda",
            "panel",
            "panic",
            "panther",
            "paper",
            "parade",
            "parent",
            "park",
            "parrot",
            "party",
            "pass",
            "patch",
            "path",
            "patient",
            "patrol",
            "pattern",
            "pause",
            "pave",
            "payment",
            "peace",
            "peanut",
            "pear",
            "peasant",
            "pelican",
            "pen",
            "penalty",
            "pencil",
            "people",
            "pepper",
            "perfect",
            "permit",
            "person",
            "pet",
            "phone",
            "photo",
            "phrase",
            "physical",
            "piano",
            "picnic",
            "picture",
            "piece",
            "pig",
            "pigeon",
            "pill",
            "pilot",
            "pink",
            "pioneer",
            "pipe",
            "pistol",
            "pitch",
            "pizza",
            "place",
            "planet",
            "plastic",
            "plate",
            "play",
            "please",
            "pledge",
            "pluck",
            "plug",
            "plunge",
            "poem",
            "poet",
            "point",
            "polar",
            "pole",
            "police",
            "pond",
            "pony",
            "pool",
            "popular",
            "portion",
            "position",
            "possible",
            "post",
            "potato",
            "pottery",
            "poverty",
            "powder",
            "power",
            "practice",
            "praise",
            "predict",
            "prefer",
            "prepare",
            "present",
            "pretty",
            "prevent",
            "price",
            "pride",
            "primary",
            "print",
            "priority",
            "prison",
            "private",
            "prize",
            "problem",
            "process",
            "produce",
            "profit",
            "program",
            "project",
            "promote",
            "proof",
            "property",
            "prosper",
            "protect",
            "proud",
            "provide",
            "public",
            "pudding",
            "pull",
            "pulp",
            "pulse",
            "pumpkin",
            "punch",
            "pupil",
            "puppy",
            "purchase",
            "purity",
            "purpose",
            "purse",
            "push",
            "put",
            "puzzle",
            "pyramid",
            "quality",
            "quantum",
            "quarter",
            "question",
            "quick",
            "quit",
            "quiz",
            "quote",
            "rabbit",
            "raccoon",
            "race",
            "rack",
            "radar",
            "radio",
            "rail",
            "rain",
            "raise",
            "rally",
            "ramp",
            "ranch",
            "random",
            "range",
            "rapid",
            "rare",
            "rate",
            "rather",
            "raven",
            "raw",
            "razor",
            "ready",
            "real",
            "reason",
            "rebel",
            "rebuild",
            "recall",
            "receive",
            "recipe",
            "record",
            "recycle",
            "reduce",
            "reflect",
            "reform",
            "refuse",
            "region",
            "regret",
            "regular",
            "reject",
            "relax",
            "release",
            "relief",
            "rely",
            "remain",
            "remember",
            "remind",
            "remove",
            "render",
            "renew",
            "rent",
            "reopen",
            "repair",
            "repeat",
            "replace",
            "report",
            "require",
            "rescue",
            "resemble",
            "resist",
            "resource",
            "response",
            "result",
            "retire",
            "retreat",
            "return",
            "reunion",
            "reveal",
            "review",
            "reward",
            "rhythm",
            "rib",
            "ribbon",
            "rice",
            "rich",
            "ride",
            "ridge",
            "rifle",
            "right",
            "rigid",
            "ring",
            "riot",
            "ripple",
            "risk",
            "ritual",
            "rival",
            "river",
            "road",
            "roast",
            "robot",
            "robust",
            "rocket",
            "romance",
            "roof",
            "rookie",
            "room",
            "rose",
            "rotate",
            "rough",
            "round",
            "route",
            "royal",
            "rubber",
            "rude",
            "rug",
            "rule",
            "run",
            "runway",
            "rural",
            "sad",
            "saddle",
            "sadness",
            "safe",
            "sail",
            "salad",
            "salmon",
            "salon",
            "salt",
            "salute",
            "same",
            "sample",
            "sand",
            "satisfy",
            "satoshi",
            "sauce",
            "sausage",
            "save",
            "say",
            "scale",
            "scan",
            "scare",
            "scatter",
            "scene",
            "scheme",
            "school",
            "science",
            "scissors",
            "scorpion",
            "scout",
            "scrap",
            "screen",
            "script",
            "scrub",
            "sea",
            "search",
            "season",
            "seat",
            "second",
            "secret",
            "section",
            "security",
            "seed",
            "seek",
            "segment",
            "select",
            "sell",
            "seminar",
            "senior",
            "sense",
            "sentence",
            "series",
            "service",
            "session",
            "settle",
            "setup",
            "seven",
            "shadow",
            "shaft",
            "shallow",
            "share",
            "shed",
            "shell",
            "sheriff",
            "shield",
            "shift",
            "shine",
            "ship",
            "shiver",
            "shock",
            "shoe",
            "shoot",
            "shop",
            "short",
            "shoulder",
            "shove",
            "shrimp",
            "shrug",
            "shuffle",
            "shy",
            "sibling",
            "sick",
            "side",
            "siege",
            "sight",
            "sign",
            "silent",
            "silk",
            "silly",
            "silver",
            "similar",
            "simple",
            "since",
            "sing",
            "siren",
            "sister",
            "situate",
            "six",
            "size",
            "skate",
            "sketch",
            "ski",
            "skill",
            "skin",
            "skirt",
            "skull",
            "slab",
            "slam",
            "sleep",
            "slender",
            "slice",
            "slide",
            "slight",
            "slim",
            "slogan",
            "slot",
            "slow",
            "slush",
            "small",
            "smart",
            "smile",
            "smoke",
            "smooth",
            "snack",
            "snake",
            "snap",
            "sniff",
            "snow",
            "soap",
            "soccer",
            "social",
            "sock",
            "soda",
            "soft",
            "solar",
            "soldier",
            "solid",
            "solution",
            "solve",
            "someone",
            "song",
            "soon",
            "sorry",
            "sort",
            "soul",
            "sound",
            "soup",
            "source",
            "south",
            "space",
            "spare",
            "spatial",
            "spawn",
            "speak",
            "special",
            "speed",
            "spell",
            "spend",
            "sphere",
            "spice",
            "spider",
            "spike",
            "spin",
            "spirit",
            "split",
            "spoil",
            "sponsor",
            "spoon",
            "sport",
            "spot",
            "spray",
            "spread",
            "spring",
            "spy",
            "square",
            "squeeze",
            "squirrel",
            "stable",
            "stadium",
            "staff",
            "stage",
            "stairs",
            "stamp",
            "stand",
            "start",
            "state",
            "stay",
            "steak",
            "steel",
            "stem",
            "step",
            "stereo",
            "stick",
            "still",
            "sting",
            "stock",
            "stomach",
            "stone",
            "stool",
            "story",
            "stove",
            "strategy",
            "street",
            "strike",
            "strong",
            "struggle",
            "student",
            "stuff",
            "stumble",
            "style",
            "subject",
            "submit",
            "subway",
            "success",
            "such",
            "sudden",
            "suffer",
            "sugar",
            "suggest",
            "suit",
            "summer",
            "sun",
            "sunny",
            "sunset",
            "super",
            "supply",
            "supreme",
            "sure",
            "surface",
            "surge",
            "surprise",
            "surround",
            "survey",
            "suspect",
            "sustain",
            "swallow",
            "swamp",
            "swap",
            "swarm",
            "swear",
            "sweet",
            "swift",
            "swim",
            "swing",
            "switch",
            "sword",
            "symbol",
            "symptom",
            "syrup",
            "system",
            "table",
            "tackle",
            "tag",
            "tail",
            "talent",
            "talk",
            "tank",
            "tape",
            "target",
            "task",
            "taste",
            "tattoo",
            "taxi",
            "teach",
            "team",
            "tell",
            "ten",
            "tenant",
            "tennis",
            "tent",
            "term",
            "test",
            "text",
            "thank",
            "that",
            "theme",
            "then",
            "theory",
            "there",
            "they",
            "thing",
            "this",
            "thought",
            "three",
            "thrive",
            "throw",
            "thumb",
            "thunder",
            "ticket",
            "tide",
            "tiger",
            "tilt",
            "timber",
            "time",
            "tiny",
            "tip",
            "tired",
            "tissue",
            "title",
            "toast",
            "tobacco",
            "today",
            "toddler",
            "toe",
            "together",
            "toilet",
            "token",
            "tomato",
            "tomorrow",
            "tone",
            "tongue",
            "tonight",
            "tool",
            "tooth",
            "top",
            "topic",
            "topple",
            "torch",
            "tornado",
            "tortoise",
            "toss",
            "total",
            "tourist",
            "toward",
            "tower",
            "town",
            "toy",
            "track",
            "trade",
            "traffic",
            "tragic",
            "train",
            "transfer",
            "trap",
            "trash",
            "travel",
            "tray",
            "treat",
            "tree",
            "trend",
            "trial",
            "tribe",
            "trick",
            "trigger",
            "trim",
            "trip",
            "trophy",
            "trouble",
            "truck",
            "true",
            "truly",
            "trumpet",
            "trust",
            "truth",
            "try",
            "tube",
            "tuition",
            "tumble",
            "tuna",
            "tunnel",
            "turkey",
            "turn",
            "turtle",
            "twelve",
            "twenty",
            "twice",
            "twin",
            "twist",
            "two",
            "type",
            "typical",
            "ugly",
            "umbrella",
            "unable",
            "unaware",
            "uncle",
            "uncover",
            "under",
            "undo",
            "unfair",
            "unfold",
            "unhappy",
            "uniform",
            "unique",
            "unit",
            "universe",
            "unknown",
            "unlock",
            "until",
            "unusual",
            "unveil",
            "update",
            "upgrade",
            "uphold",
            "upon",
            "upper",
            "upset",
            "urban",
            "urge",
            "usage",
            "use",
            "used",
            "useful",
            "useless",
            "usual",
            "utility",
            "vacant",
            "vacuum",
            "vague",
            "valid",
            "valley",
            "valve",
            "van",
            "vanish",
            "vapor",
            "various",
            "vast",
            "vault",
            "vehicle",
            "velvet",
            "vendor",
            "venture",
            "venue",
            "verb",
            "verify",
            "version",
            "very",
            "vessel",
            "veteran",
            "viable",
            "vibrant",
            "vicious",
            "victory",
            "video",
            "view",
            "village",
            "vintage",
            "violin",
            "virtual",
            "virus",
            "visa",
            "visit",
            "visual",
            "vital",
            "vivid",
            "vocal",
            "voice",
            "void",
            "volcano",
            "volume",
            "vote",
            "voyage",
            "wage",
            "wagon",
            "wait",
            "walk",
            "wall",
            "walnut",
            "want",
            "warfare",
            "warm",
            "warrior",
            "wash",
            "wasp",
            "waste",
            "water",
            "wave",
            "way",
            "wealth",
            "weapon",
            "wear",
            "weasel",
            "weather",
            "web",
            "wedding",
            "weekend",
            "weird",
            "welcome",
            "west",
            "wet",
            "whale",
            "what",
            "wheat",
            "wheel",
            "when",
            "where",
            "whip",
            "whisper",
            "wide",
            "width",
            "wife",
            "wild",
            "will",
            "win",
            "window",
            "wine",
            "wing",
            "wink",
            "winner",
            "winter",
            "wire",
            "wisdom",
            "wise",
            "wish",
            "witness",
            "wolf",
            "woman",
            "wonder",
            "wood",
            "wool",
            "word",
            "work",
            "world",
            "worry",
            "worth",
            "wrap",
            "wreck",
            "wrestle",
            "wrist",
            "write",
            "wrong",
            "yard",
            "year",
            "yellow",
            "you",
            "young",
            "youth",
            "zebra",
            "zero",
            "zone",
            "zoo"
        ];
    </script>

    <!-- ==========================================================================
    SHA-256 LIBRARY (Embedded for offline use)
    - Adapted from js-sha256 v0.9.0 (MIT License) https://github.com/emn178/js-sha256
    - Provides a pure-JavaScript SHA-256 implementation that works in air-gapped sessions.
    ========================================================================== -->
    <script>
        (function (root) {
            'use strict';

            const K = new Uint32Array([
                0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5,
                0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174,
                0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da,
                0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967,
                0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85,
                0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070,
                0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3,
                0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2
            ]);

            const INITIAL_HASH = new Uint32Array([
                0x6a09e667, 0xbb67ae85, 0x3c6ef372, 0xa54ff53a,
                0x510e527f, 0x9b05688c, 0x1f83d9ab, 0x5be0cd19
            ]);

            function rightRotate(value, amount) {
                return (value >>> amount) | (value << (32 - amount));
            }

            function utf8ToBytes(str) {
                if (typeof TextEncoder !== 'undefined') {
                    return new TextEncoder().encode(str);
                }
                const bytes = [];
                for (let i = 0; i < str.length; i++) {
                    let codePoint = str.charCodeAt(i);
                    if (codePoint < 0x80) {
                        bytes.push(codePoint);
                    } else if (codePoint < 0x800) {
                        bytes.push(0xc0 | (codePoint >> 6));
                        bytes.push(0x80 | (codePoint & 0x3f));
                    } else if (codePoint >= 0xd800 && codePoint <= 0xdbff) {
                        i++;
                        const next = str.charCodeAt(i);
                        codePoint = ((codePoint - 0xd800) << 10) + (next - 0xdc00) + 0x10000;
                        bytes.push(0xf0 | (codePoint >> 18));
                        bytes.push(0x80 | ((codePoint >> 12) & 0x3f));
                        bytes.push(0x80 | ((codePoint >> 6) & 0x3f));
                        bytes.push(0x80 | (codePoint & 0x3f));
                    } else {
                        bytes.push(0xe0 | (codePoint >> 12));
                        bytes.push(0x80 | ((codePoint >> 6) & 0x3f));
                        bytes.push(0x80 | (codePoint & 0x3f));
                    }
                }
                return new Uint8Array(bytes);
            }

            function normalizeInput(message) {
                if (message instanceof Uint8Array) {
                    return message;
                }
                if (typeof message === 'string') {
                    return utf8ToBytes(message);
                }
                if (message instanceof ArrayBuffer) {
                    return new Uint8Array(message);
                }
                if (ArrayBuffer.isView(message)) {
                    return new Uint8Array(message.buffer, message.byteOffset, message.byteLength);
                }
                throw new TypeError('sha256: unsupported message type');
            }

            function sha256DigestBytes(message) {
                const bytes = normalizeInput(message);
                const length = bytes.length;
                const bitLength = length * 8;
                const paddedLength = (length + 9 + 63) & ~63;
                const padded = new Uint8Array(paddedLength);
                padded.set(bytes);
                padded[length] = 0x80;
                const view = new DataView(padded.buffer);
                view.setUint32(paddedLength - 8, Math.floor(bitLength / 0x100000000));
                view.setUint32(paddedLength - 4, bitLength >>> 0);

                const w = new Uint32Array(64);
                let h0 = INITIAL_HASH[0];
                let h1 = INITIAL_HASH[1];
                let h2 = INITIAL_HASH[2];
                let h3 = INITIAL_HASH[3];
                let h4 = INITIAL_HASH[4];
                let h5 = INITIAL_HASH[5];
                let h6 = INITIAL_HASH[6];
                let h7 = INITIAL_HASH[7];

                for (let offset = 0; offset < paddedLength; offset += 64) {
                    for (let i = 0; i < 16; i++) {
                        w[i] = view.getUint32(offset + (i << 2));
                    }
                    for (let i = 16; i < 64; i++) {
                        const s0 = (rightRotate(w[i - 15], 7) ^ rightRotate(w[i - 15], 18) ^ (w[i - 15] >>> 3)) >>> 0;
                        const s1 = (rightRotate(w[i - 2], 17) ^ rightRotate(w[i - 2], 19) ^ (w[i - 2] >>> 10)) >>> 0;
                        w[i] = (((((w[i - 16] + s0) >>> 0) + w[i - 7]) >>> 0) + s1) >>> 0;
                    }

                    let a = h0;
                    let b = h1;
                    let c = h2;
                    let d = h3;
                    let e = h4;
                    let f = h5;
                    let g = h6;
                    let h = h7;

                    for (let i = 0; i < 64; i++) {
                        const S1 = (rightRotate(e, 6) ^ rightRotate(e, 11) ^ rightRotate(e, 25)) >>> 0;
                        const ch = ((e & f) ^ (~e & g)) >>> 0;
                        const temp1 = ((((((h + S1) >>> 0) + ch) >>> 0) + K[i]) >>> 0) + w[i];
                        const S0 = (rightRotate(a, 2) ^ rightRotate(a, 13) ^ rightRotate(a, 22)) >>> 0;
                        const maj = ((a & b) ^ (a & c) ^ (b & c)) >>> 0;
                        const temp2 = (S0 + maj) >>> 0;

                        h = g;
                        g = f;
                        f = e;
                        e = (d + temp1) >>> 0;
                        d = c;
                        c = b;
                        b = a;
                        a = (temp1 + temp2) >>> 0;
                    }

                    h0 = (h0 + a) >>> 0;
                    h1 = (h1 + b) >>> 0;
                    h2 = (h2 + c) >>> 0;
                    h3 = (h3 + d) >>> 0;
                    h4 = (h4 + e) >>> 0;
                    h5 = (h5 + f) >>> 0;
                    h6 = (h6 + g) >>> 0;
                    h7 = (h7 + h) >>> 0;
                }

                const digest = new Uint8Array(32);
                const digestView = new DataView(digest.buffer);
                digestView.setUint32(0, h0);
                digestView.setUint32(4, h1);
                digestView.setUint32(8, h2);
                digestView.setUint32(12, h3);
                digestView.setUint32(16, h4);
                digestView.setUint32(20, h5);
                digestView.setUint32(24, h6);
                digestView.setUint32(28, h7);
                return digest;
            }

            function toHex(bytes) {
                const HEX = '0123456789abcdef';
                let out = '';
                for (let i = 0; i < bytes.length; i++) {
                    out += HEX[bytes[i] >>> 4] + HEX[bytes[i] & 0x0f];
                }
                return out;
            }

            function sha256(message) {
                return toHex(sha256DigestBytes(message));
            }

            sha256.array = function (message) {
                return Array.from(sha256DigestBytes(message));
            };

            sha256.digest = function (message) {
                return sha256DigestBytes(message);
            };

            sha256.arrayBuffer = function (message) {
                return sha256DigestBytes(message).buffer;
            };

            if (typeof module !== 'undefined' && module.exports) {
                module.exports = sha256;
            } else {
                root.sha256 = sha256;
            }
        })(typeof self !== 'undefined' ? self : globalThis);
    </script>
</body>
</html>
